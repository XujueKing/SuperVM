# Phase 13 M13.8 Throughput Acceptance

Date: 2025-11-12

Scope: Define environment, workload, methodology, and pass criteria for >=2× throughput vs baseline (runtime_seq).

## 1) Environment
- OS: Windows 10/11 x64
- CPU: >= 8 logical cores
- RAM: >= 16 GB
- Rust: stable toolchain (>= 1.77)
- Build features:
  - Baseline: `vm-runtime` without `hybrid-exec`
  - Hybrid: `vm-runtime` with `hybrid-exec` (optionally `hybrid-lite`)
- Optional GPU: if available, ensure drivers installed; GPU path is currently experimental.

## 2) Workloads
- Synthetic compute: busy_work u64 -> i32 with iterations=512
- Batch size: 50,000 elements (default); may also test 100k for saturation check
- Transaction shape: `(TxId, u64, fn(u64)->i32)`

## 3) Commands (PowerShell)
- Baseline (runtime_seq path):
```
cargo bench -p vm-runtime --features hybrid-exec --bench hybrid_benchmark -- runtime_seq --warm-up-time 0.2 --measurement-time 0.6
```
- Hybrid (fn pointer fast path):
```
cargo bench -p vm-runtime --features hybrid-exec --bench hybrid_benchmark -- runtime_hybrid_fnptr --warm-up-time 0.2 --measurement-time 0.6
```
- Hybrid (chunked; recommended):
```
cargo bench -p vm-runtime --features hybrid-exec --bench hybrid_benchmark -- runtime_hybrid_fnptr_chunked --warm-up-time 0.2 --measurement-time 0.6
```
- Hybrid (auto-chunked, tunable):
```
$env:HYBRID_AUTO_CHUNK_THRESHOLD=2000; $env:HYBRID_CHUNK_SIZE=1000; cargo bench -p vm-runtime --features hybrid-exec --bench hybrid_benchmark -- runtime_hybrid_auto_chunked -- --warm-up-time 0.2 --measurement-time 0.6
```
- Lite mode (disable metrics overhead):
```
cargo bench -p vm-runtime --features "hybrid-exec,hybrid-lite" --bench hybrid_benchmark -- runtime_hybrid_fnptr_chunked -- --warm-up-time 0.2 --measurement-time 0.6
```

## 4) Metrics & Methodology
- Primary: mean latency (ms) for batch; derived throughput elements/s (criterion thrpt)
- Secondary: p95 latency (criterion provides distribution)
- Runs: 3 independent runs; report the median of means
- System telemetry: optional CPU utilization via Task Manager (or `typeperf`), note core saturation

## 5) Pass Criteria
- Throughput speedup >= 2× vs baseline `runtime_seq` under identical workload and hardware
- Stability: coefficient of variation (stddev/mean) < 10% across 3 runs
- Optional: p95 latency under hybrid <= 0.75× baseline p95 (if measured)

## 6) Recommended Defaults
- Chunk size: 1000 (empirically good trade-off)
- Auto threshold: 2000 (hybrid auto-chunked switches when tasks > threshold)
- Enable `hybrid-lite` for pure execution overhead measurements; disable for production-like runs with metrics

## 7) Reporting Template
- Hardware: CPU model, cores/threads, RAM, OS build
- Features: hybrid-exec, hybrid-lite (on/off)
- Workload: batch size, iterations
- Results (ms): seq, hybrid_dyn, hybrid_fnptr, hybrid_fnptr_chunked, hybrid_auto_chunked
- Speedups: relative to seq
- Notes: anomalies, outliers, ambient load

## 8) Notes
- Auto-chunked uses dynamic aggregation to remain generic; its performance is between fnptr-chunked and non-chunked fnptr.
- For GPU validation later, add GPU-specific rows; ensure GPU backend compiles and record device name + driver version.
