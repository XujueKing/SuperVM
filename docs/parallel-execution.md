# å¹¶è¡Œæ‰§è¡Œå¼•æ“è®¾è®¡æ–‡æ¡£# éªæƒ°î”‘éµÑ†î”‘å¯®æ›Ÿæ¸ç’æî…¸é‚å›¨ã€‚



ä½œè€…: king  æµ£æ»†â‚¬? king  

ç‰ˆæœ¬: v0.7.0  é—å Ÿæ¹°: v0.6.0  

æ—¥æœŸ: 2025-11-04éƒãƒ¦æ¹¡: 2025-11-04



## ç›®å½•## é©î†¼ç¶



- [æ¦‚è¿°](#æ¦‚è¿°)- [å§’å‚å ª](#å§’å‚å ª)

- [æ¶æ„è®¾è®¡](#æ¶æ„è®¾è®¡)- [é‹èˆµç€¯ç’æî…¸](#é‹èˆµç€¯ç’æî…¸)

- [æ ¸å¿ƒç»„ä»¶](#æ ¸å¿ƒç»„ä»¶)- [éç¨¿ç¸¾ç¼å‹ªæ¬¢](#éç¨¿ç¸¾ç¼å‹ªæ¬¢)

- [å…³é”® API](#å…³é”®-api)- [API é™å‚â‚¬åƒ(#api-é™å‚â‚¬?

- [å¹¶è¡Œè°ƒåº¦](#å¹¶è¡Œè°ƒåº¦)- [æµ£è·¨æ•¤ç»€è½°ç·¥](#æµ£è·¨æ•¤ç»€è½°ç·¥)

- [ç¤ºä¾‹](#ç¤ºä¾‹)- [é¬Ñ†å…˜æµ¼æ¨ºå¯²](#é¬Ñ†å…˜æµ¼æ¨ºå¯²)

- [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)- [å¨´å¬­ç˜¯æ¥ å²ƒç˜‰](#å¨´å¬­ç˜¯æ¥ å²ƒç˜‰)

- [æµ‹è¯•ä¸åŸºå‡†](#æµ‹è¯•ä¸åŸºå‡†)

---

---

## å§’å‚å ª

## æ¦‚è¿°

SuperVM éªæƒ°î”‘éµÑ†î”‘å¯®æ›Ÿæ¸éƒã„¥æ¹ªé»æ„°ç®é–å“„æ½¡é–¾å¥æ°¦é„æ’³î˜©éå——æ‚¶éšæ„°å™ºé”›å²„â‚¬æ°³ç¹ƒé…é¸¿å…˜éèŒ¬çŠå¦«â‚¬å¨´å¬ªæ‹°æ¸šæ¿Šç¦†é’å—˜ç€½é”›å±½æ¹ªæ·‡æ¿Šç˜‰å§ï½‡â€˜é¬Ñ…æ®‘é“å¶†å½æ¶“å¬«æ¸¶æ¾¶Ñƒå¯²éªæƒ°î”‘éµÑ†î”‘éå ¢å·¼éŠ†?

SuperVM å¹¶è¡Œæ‰§è¡Œå¼•æ“æ—¨åœ¨æé«˜åŒºå—é“¾äº¤æ˜“å¤„ç†ååé‡ï¼Œé€šè¿‡æ™ºèƒ½å†²çªæ£€æµ‹å’Œä¾èµ–åˆ†æï¼Œåœ¨ä¿è¯æ­£ç¡®æ€§çš„å‰æä¸‹æœ€å¤§åŒ–å¹¶è¡Œæ‰§è¡Œæ•ˆç‡ã€‚

### ç’æî…¸é©î†½çˆ£

### è®¾è®¡ç›®æ ‡

- é‰?**å§ï½‡â€˜é¬Ñ‚ç´­é?*: çº­î†»ç¹šæµœã‚†æ§—éµÑ†î”‘æ¤¤å“„ç°­å§ï½‡â€˜é¬?

- âœ… **æ­£ç¡®æ€§ä¼˜å…ˆ**: ç¡®ä¿äº¤æ˜“æ‰§è¡Œé¡ºåºæ­£ç¡®æ€§- é‰?**æ¥‚æ¨ºæ‚¶éšæ„°å™º**: éˆâ‚¬æ¾¶Ñƒå¯²éªæƒ°î”‘éµÑ†î”‘éå ¢å·¼

- âœ… **é«˜ååé‡**: æœ€å¤§åŒ–å¹¶è¡Œæ‰§è¡Œæ•ˆç‡- é‰?**é‘·î„å§©é­ãˆ î˜²**: æ¾¶è¾«è§¦æµœã‚†æ§—é‘·î„å§©é¥ç‚´ç²´

- âœ… **è‡ªåŠ¨æ¢å¤**: å¤±è´¥äº¤æ˜“è‡ªåŠ¨å›æ»š# å¹¶è¡Œæ‰§è¡Œå¼•æ“è®¾è®¡æ–‡æ¡£



---- [æ¶æ„è®¾è®¡](#æ¶æ„è®¾è®¡)

- [æ ¸å¿ƒç»„ä»¶](#æ ¸å¿ƒç»„ä»¶)

## æ¶æ„è®¾è®¡- [å…³é”® API](#å…³é”®-api)

- [å¹¶è¡Œè°ƒåº¦](#å¹¶è¡Œè°ƒåº¦)

### æ€»ä½“æµç¨‹- [ç¤ºä¾‹](#ç¤ºä¾‹)

- [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)

```- [æµ‹è¯•ä¸åŸºå‡†](#æµ‹è¯•ä¸åŸºå‡†)

äº¤æ˜“è¾“å…¥ â†’ è¯»å†™é›†æå– â†’ å†²çªæ£€æµ‹ â†’ ä¾èµ–å›¾æ„å»º â†’ å¹¶è¡Œè°ƒåº¦

```SuperVM å¹¶è¡Œæ‰§è¡Œå¼•æ“ç”¨äºåœ¨ä¿è¯æ­£ç¡®æ€§çš„å‰æä¸‹ï¼Œæœ€å¤§åŒ–ååå¹¶æœ€å°åŒ–å»¶è¿Ÿï¼›é€šè¿‡æ™ºèƒ½å†²çªæ£€æµ‹ä¸ä¾èµ–åˆ†æï¼Œå®ç°å®‰å…¨å¯æ§çš„å¹¶è¡ŒåŒ–ã€‚



```- æ­£ç¡®æ€§ä¼˜å…ˆï¼šä¸¥æ ¼ä¿è¯äº‹åŠ¡æ‰§è¡Œé¡ºåºå’Œä¸€è‡´æ€§

      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”- é«˜ååï¼šå……åˆ†å¹¶è¡ŒåŒ–ä¸æ‰¹å¤„ç†ä¼˜åŒ–

      â”‚  Tx Input  â”‚ â”€â”€â–¶ â”‚  RWSet Build â”‚ â”€â”€â–¶ â”‚ Conflict Checkâ”‚- è‡ªåŠ¨é‡è¯•ï¼šå†²çªæ—¶è‡ªåŠ¨å›é€€ä¸é‡è¯•

      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜- å¯è§‚æµ‹æ€§ï¼šå®Œæ•´æ‰§è¡Œä¸è°ƒåº¦ç»Ÿè®¡

                â”‚                               â”‚

                â–¼                               â–¼## æ¶æ„è®¾è®¡

           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”

           â”‚Dependency DAGâ”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶  â”‚Parallel Schedâ”‚### æ€»ä½“æµç¨‹

           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                                                    â”‚äº¤æ˜“è¾“å…¥ â†’ è¯»å†™é›†æå– â†’ å†²çªæ£€æµ‹ â†’ ä¾èµ–å›¾æ„å»º â†’ å¹¶è¡Œè°ƒåº¦

                                                    â–¼

                                         æäº¤æˆ–è‡ªåŠ¨é‡è¯•/å›é€€```

```      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”

      â”‚  Tx Input  â”‚ â”€â”€â–¶ â”‚  RWSet Build â”‚ â”€â”€â–¶ â”‚ Conflict Checkâ”‚

### æ ¸å¿ƒåŸç†      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                â”‚                               â”‚

1. **è¯»å†™é›†åˆ†æ**: è®°å½•æ¯ä¸ªäº¤æ˜“çš„è¯»å†™é”®é›†åˆ                â–¼                               â–¼

2. **å†²çªæ£€æµ‹**:            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”

   - RAW (Read-After-Write): è¯»åå†™å†²çª           â”‚Dependency DAGâ”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶  â”‚Parallel Schedâ”‚

   - WAR (Write-After-Read): å†™åè¯»å†²çª           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   - WAW (Write-After-Write): å†™åå†™å†²çª                                                    â”‚

3. **ä¾èµ–å›¾**: æ„å»ºäº¤æ˜“ä¹‹é—´çš„ä¾èµ–å…³ç³»                                                    â–¼

4. **å¹¶è¡Œæ‰§è¡Œ**: æ ¹æ®ä¾èµ–å…³ç³»å®‰æ’å¹¶è¡Œæ‰¹æ¬¡                                         æäº¤æˆ–è‡ªåŠ¨é‡è¯•/å›é€€

5. **è‡ªåŠ¨å›æ»š**: å¤±è´¥æ—¶è‡ªåŠ¨å›é€€å¹¶å¯é€‰é‡è¯•```



---## æ ¸å¿ƒç»„ä»¶



## æ ¸å¿ƒç»„ä»¶1) RW é›†åˆï¼ˆRWSetï¼‰

- RAWï¼ˆRead-After-Writeï¼‰ã€WARï¼ˆWrite-After-Readï¼‰å†²çªç±»å‹è¯†åˆ«

### 1. ReadWriteSet (è¯»å†™é›†)- é”®çº§åˆ«å†²çªç²’åº¦ï¼Œæ”¯æŒå‰ç¼€æˆ–ç²¾ç¡®é”®



**ç”¨é€”**: è®°å½•äº¤æ˜“çš„è¯»å†™é”®é›†åˆ2) ä¾èµ–å›¾ï¼ˆDependencyGraphï¼‰

- build_dependency_graph(tx_order): æ„å»ºä¾èµ–å…³ç³»å›¾

```rust- è®°å½•éœ€ç­‰å¾…çš„ä¾èµ–ä¸å¯å¹¶è¡Œçš„äº¤æ˜“æ‰¹æ¬¡

pub struct ReadWriteSet {

    pub reads: HashSet<Vec<u8>>,3) çŠ¶æ€ç®¡ç†ï¼ˆStateManagerï¼‰

    pub writes: HashSet<Vec<u8>>,- è´Ÿè´£å¿«ç…§ä¸å›æ»šï¼›çº¿ç¨‹å®‰å…¨ï¼ˆArc<Mutex> ç­‰ï¼‰

}- commit(): æäº¤å¹¶é‡Šæ”¾å¿«ç…§

```

4) æ‰§è¡Œç»Ÿè®¡ï¼ˆExecutionStatsï¼‰

**æ–¹æ³•**:- å­—æ®µï¼šsuccessful_txs, failed_txs, conflicts, retries, elapsed

- `new()`: åˆ›å»ºç©ºçš„è¯»å†™é›†- total_txs(), success_rate() ç­‰ä¾¿æ·æ–¹æ³•

- `add_read(key)`: è®°å½•è¯»æ“ä½œ

- `add_write(key)`: è®°å½•å†™æ“ä½œ5) å¹¶è¡Œè°ƒåº¦å™¨ï¼ˆParallelSchedulerï¼‰

- `has_conflict(&other)`: æ£€æµ‹ä¸å¦ä¸€ä¸ªè¯»å†™é›†æ˜¯å¦å†²çª- ç»Ÿä¸€ç¼–æ’æ‰€æœ‰æ‰¹æ¬¡æ‰§è¡Œï¼Œè¿½è¸ªå¹¶è¡Œåº¦ä¸å›é€€

- æ”¯æŒæŒ‰ä¼˜å…ˆçº§è°ƒåº¦ä¸å·¥ä½œçªƒå–

---

## å…³é”® API

### 2. ConflictDetector (å†²çªæ£€æµ‹å™¨)

- build_dependency_graph(tx_order)

**ç”¨é€”**: æ£€æµ‹äº¤æ˜“ä¹‹é—´çš„å†²çªå…³ç³»- execute_with_snapshot<F>(...)ï¼šåœ¨å¿«ç…§ä¸‹æ‰§è¡Œ

- execute_with_retry<F>(max_retries)ï¼šè‡ªåŠ¨é‡è¯•

```rust- execute_batch(ops)ï¼šå•æ‰¹å¹¶è¡Œæ‰§è¡Œï¼ˆå­äº‹åŠ¡çº§æäº¤/å›æ»šï¼‰

pub struct ConflictDetector {- batch_write/read/delete(...)ï¼šæ‰¹é‡å­˜å–é™ä½é”ç«äº‰

    rw_sets: HashMap<TxId, ReadWriteSet>,- get_stats()ï¼šè·å–æ‰§è¡Œç»Ÿè®¡

}

```## å¹¶è¡Œè°ƒåº¦



**æ–¹æ³•**:è°ƒåº¦ç­–ç•¥ï¼ˆæ¦‚è¿°ï¼‰ï¼š

- `new()`: åˆ›å»ºæ£€æµ‹å™¨- æ¯ä¸ªå·¥ä½œçº¿ç¨‹æœ‰æœ¬åœ°é˜Ÿåˆ—ï¼ˆFIFOï¼‰ï¼›ä¼˜å…ˆä»æœ¬åœ°å–ä»»åŠ¡

- `record(tx_id, rw_set)`: è®°å½•äº¤æ˜“çš„è¯»å†™é›†- æœ¬åœ°ä¸ºç©ºæ—¶ï¼Œä»å…¨å±€é˜Ÿåˆ—æ‰¹é‡è·å–ï¼Œæˆ–å¯¹å…¶ä»–çº¿ç¨‹è¿›è¡Œå·¥ä½œçªƒå–

- `has_conflict(tx1, tx2)`: æ£€æµ‹ä¸¤ä¸ªäº¤æ˜“æ˜¯å¦å†²çª- ä»»åŠ¡æ”¯æŒ priority: u8ï¼ˆ0-255ï¼Œè¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜ï¼‰

- `build_dependency_graph(tx_order)`: æ„å»ºä¾èµ–å›¾

æ ¸å¿ƒæ¥å£ï¼š

---- submit_task(task) / submit_tasks(tasks)

- execute_all<F>(executor) æ‰§è¡Œæ‰€æœ‰å¾…å¤„ç†ä»»åŠ¡

### 3. DependencyGraph (ä¾èµ–å›¾)- get_stats() è·å–è°ƒåº¦ä¸æ‰§è¡Œç»Ÿè®¡



**ç”¨é€”**: è¡¨ç¤ºäº¤æ˜“ä¹‹é—´çš„ä¾èµ–å…³ç³»## ç¤ºä¾‹



```rust1) Alice å‘ Bob è½¬è´¦ï¼ˆæ— å†²çªè·¯å¾„ï¼‰

pub struct DependencyGraph {- ç‹¬ç«‹é”®è®¿é—®ï¼Œæ—  RW å†²çªï¼Œå¯ç›´æ¥å¹¶è¡Œæäº¤

    dependencies: HashMap<TxId, HashSet<TxId>>,  // tx -> depends_on

}2) è¯»å†™å†²çªç¤ºä¾‹ï¼ˆtx1/tx2/tx3ï¼‰

```- tx1 å†™ bobï¼›tx2 è¯» bobï¼›tx3 å†™ alice

- ä¾èµ–å›¾å¯ä½¿ tx1 ä¸ tx3 å¹¶è¡Œï¼Œtx2 ç­‰å¾… tx1 å®Œæˆå†æ‰§è¡Œ

**æ–¹æ³•**:

- `add_dependency(tx, depends_on)`: æ·»åŠ ä¾èµ–å…³ç³»3) åµŒå¥—äº‹åŠ¡ï¼ˆNested Transactionsï¼‰

- `get_ready_txs(completed)`: è·å–å°±ç»ªçš„äº¤æ˜“é›†åˆ- åœ¨å•ä¸ªäº‹åŠ¡é‡ŒåŒ…å«å­æ“ä½œï¼›æ¯ä¸ªå­æ“ä½œæ‹¥æœ‰è‡ªèº«å¿«ç…§ï¼›å¤±è´¥åˆ™å­å›æ»š

- `is_ready(tx, completed)`: æ£€æŸ¥äº¤æ˜“æ˜¯å¦å°±ç»ª

## æ€§èƒ½ä¼˜åŒ–

---

1) æœ€å°åŒ–é”æŒæœ‰æ—¶é—´

### 4. StateManager (çŠ¶æ€ç®¡ç†å™¨)- ä»…åœ¨å…³é”®è·¯å¾„æŒé”ï¼›åˆ†è§£ä¸ºâ€œå‡†å¤‡-æäº¤â€ä¸¤é˜¶æ®µï¼›

- å°½é‡è¯»å†™åœ¨å¿«ç…§ä¸­è¿›è¡Œï¼Œæäº¤é˜¶æ®µçŸ­æš‚åˆ‡å…¥ä¸´ç•ŒåŒº

**ç”¨é€”**: ç®¡ç†çŠ¶æ€å¿«ç…§å’Œå›æ»š

2) æ‰¹é‡æ“ä½œ

```rust- æ‰¹é‡æ„å»ºè¯»å†™é›†ã€æ‰¹é‡å¿«ç…§åˆ›å»º/é‡Šæ”¾ã€æ‰¹é‡æäº¤ï¼Œå‡å°‘åˆ‡æ¢ä¸é”ç«äº‰

pub struct StateManager {

    storage: Arc<Mutex<HashMap<Vec<u8>, Vec<u8>>>>,3) å¿«ç…§éš”ç¦»

    snapshots: Arc<Mutex<Vec<HashMap<Vec<u8>, Vec<u8>>>>>,- execute_with_snapshot() é™ä½å…±äº«çŠ¶æ€äº‰ç”¨

}

```4) çº¿ç¨‹å®‰å…¨ä¸é…ç½®

- è¾ƒé‡è·¯å¾„ä½¿ç”¨ Arc<Mutex>/RwLockï¼›ç»“åˆæ— é”ç»“æ„ï¼ˆå¦‚é˜Ÿåˆ—ï¼‰

**æ–¹æ³•**:- å¯è°ƒå¹¶è¡Œåº¦ã€æ‰¹å¤§å°ã€é‡è¯•æ¬¡æ•°ç­‰

- `create_snapshot()`: åˆ›å»ºå½“å‰çŠ¶æ€å¿«ç…§

- `rollback()`: å›æ»šåˆ°ä¸Šä¸€ä¸ªå¿«ç…§## æµ‹è¯•ä¸åŸºå‡†

- `commit()`: æäº¤å½“å‰å¿«ç…§

- `get_storage()`: è·å–å­˜å‚¨å¼•ç”¨æµ‹è¯•è¦†ç›–ï¼ˆå»ºè®®ï¼‰ï¼š

- `snapshot_depth()`: è·å–å¿«ç…§æ·±åº¦- çŠ¶æ€ç®¡ç†ï¼ˆ5 é¡¹ï¼‰ï¼šå¿«ç…§/å›æ»š/æäº¤è¾¹ç•Œ

- è°ƒåº¦å™¨ï¼ˆ3 é¡¹ï¼‰ï¼šé˜Ÿåˆ—ã€å·¥ä½œçªƒå–ã€ä¼˜å…ˆçº§

---- ç»Ÿè®¡ä¸é‡è¯•ï¼ˆ3 é¡¹ï¼‰ï¼šå†²çªé‡è¯•ä¸æˆåŠŸç‡



### 5. ExecutionStats (æ‰§è¡Œç»Ÿè®¡)æµ‹è¯•åœºæ™¯ï¼š

1) æ— å†²çªï¼š10/100/1000 æ¡æ•°æ®

**ç”¨é€”**: æ”¶é›†å’ŒæŠ¥å‘Šæ‰§è¡ŒæŒ‡æ ‡2) ä¸­åº¦/é«˜åº¦å†²çªï¼šæŒ‰æ¯”ä¾‹åˆ¶é€  RAW/WAR å†²çª

3) å¹¶è¡Œæ‰¹æ¬¡å¤§å°è°ƒä¼˜

```rust

pub struct ExecutionStats {Criterion æŠ¥å‘Šï¼š

    pub successful_txs: u64,    // æˆåŠŸäº¤æ˜“æ•°- æ‰“å¼€ï¼štarget/criterion/report/index.html

    pub failed_txs: u64,        // å¤±è´¥äº¤æ˜“æ•°- æŒ‡æ ‡é‡Šä¹‰ï¼šmean/medianï¼ˆå¹³å‡/ä¸­ä½ï¼‰ã€slopeã€std_devï¼ˆæ ‡å‡†å·®ï¼‰ã€confidence_intervalï¼ˆé»˜è®¤ 95%ï¼‰

    pub rollback_count: u64,    // å›æ»šæ¬¡æ•°- å•ä½ï¼šns/iterï¼ˆCriterion é»˜è®¤ï¼‰

    pub retry_count: u64,       // é‡è¯•æ¬¡æ•°

    pub conflict_count: u64,    // å†²çªæ¬¡æ•°ç¤ºä¾‹åŸºå‡†æŒ‡æ ‡ï¼ˆå‚è€ƒåˆæµ‹ï¼‰ï¼š

}- å¹¶è¡Œæ‰¹æ¬¡ get_parallel_batch/100ï¼šâ‰ˆ350,045 ns/æ‰¹

```- æ— å†²çª non_conflicting/100ï¼šâ‰ˆ396,673 ns

- 50% å†²çª/100ï¼šâ‰ˆ460,675 ns

**è®¡ç®—æŒ‡æ ‡**:- å¿«ç…§åˆ›å»º create_snapshot/1000ï¼šâ‰ˆ224,712 ns

- `total_txs()`: æ€»äº¤æ˜“æ•°- ä¾èµ–å›¾ build_and_query/100ï¼šâ‰ˆ344,862 ns

- `success_rate()`: æˆåŠŸç‡

- `rollback_rate()`: å›æ»šç‡â€”â€” ä»¥ä¸Šä¸º UTF-8 ä¿®æ­£ç‰ˆï¼Œä¿ç•™åŸè®¾è®¡æ„å›¾ä¸æœ¯è¯­ï¼Œå¹¶ç»Ÿä¸€ä¸º SuperVM å‘½å â€”â€”

- `snapshot_depth()`: é‘¾å³°å½‡è¹‡î‚¤åå¨£åå®³

---

---

### 6. ParallelScheduler (å¹¶è¡Œè°ƒåº¦å™¨)

### 5. ExecutionStats (éµÑ†î”‘ç¼ç†»î…¸)

**ç”¨é€”**: åè°ƒæ‰€æœ‰ç»„ä»¶ï¼Œç®¡ç†å¹¶è¡Œæ‰§è¡Œ

**é¢ã„©â‚¬?*: é€å •æ³¦éœå±¾å§¤é›å©ƒå¢½ç›å±¾å¯šé?

```rust

pub struct ParallelScheduler {```rust

    detector: Arc<Mutex<ConflictDetector>>,pub struct ExecutionStats {

    completed: Arc<Mutex<HashSet<TxId>>>,    pub successful_txs: u64,    // é´æ„¬å§›æµœã‚†æ§—é?

    state_manager: Arc<Mutex<StateManager>>,    pub failed_txs: u64,        // æ¾¶è¾«è§¦æµœã‚†æ§—é?

    // åŸå­ç»Ÿè®¡è®¡æ•°å™¨    pub rollback_count: u64,    // é¥ç‚´ç²´å¨†â„ƒæšŸ

    stats_successful: Arc<AtomicU64>,    pub retry_count: u64,       // é–²å¶ˆç˜¯å¨†â„ƒæšŸ

    stats_failed: Arc<AtomicU64>,    pub conflict_count: u64,    // éèŒ¬çŠå¨†â„ƒæšŸ

    stats_rollback: Arc<AtomicU64>,}

    stats_retry: Arc<AtomicU64>,```

    stats_conflict: Arc<AtomicU64>,

}**ç’ï¼„ç•»é¸å›¨çˆ£**:

```- `total_txs()`: é¬è®³æ°¦é„æ’´æšŸ

- `success_rate()`: é´æ„¬å§›éœ?

**æ ¸å¿ƒæ–¹æ³•**:- `rollback_rate()`: é¥ç‚´ç²´éœ?

- `execute_with_snapshot<F>()`: å¿«ç…§ä¿æŠ¤æ‰§è¡Œ

- `execute_with_retry<F>(max_retries)`: è‡ªåŠ¨é‡è¯•æ‰§è¡Œ---

- `execute_batch(ops)`: æ‰¹é‡æ‰§è¡Œä¸€ç»„äº¤æ˜“ï¼ŒåŸå­æäº¤/å›æ»š

- `batch_write/read/delete(...)`: æ‰¹é‡å­˜å‚¨æ“ä½œï¼Œé™ä½é”äº‰ç”¨### 6. ParallelScheduler (éªæƒ°î”‘ç’‹å†¨å®³é£?

- `get_parallel_batch()`: è·å–å¯å¹¶è¡Œäº¤æ˜“

- `get_stats()`: è·å–æ‰§è¡Œç»Ÿè®¡**é¢ã„©â‚¬?*: é—å¿šçšŸéµâ‚¬éˆå¤Œç²æµ è®¹ç´ç» ï¼„æ‚Šéªæƒ°î”‘éµÑ†î”‘



---```rust

pub struct ParallelScheduler {

### 7. WorkStealingScheduler (å·¥ä½œçªƒå–è°ƒåº¦å™¨)    detector: Arc<Mutex<ConflictDetector>>,

    completed: Arc<Mutex<HashSet<TxId>>>,

**ç”¨é€”**: ä½¿ç”¨å·¥ä½œçªƒå–ç®—æ³•å®ç°è´Ÿè½½å‡è¡¡çš„å¹¶è¡Œè°ƒåº¦    state_manager: Arc<Mutex<StateManager>>,

    // é˜ç†·ç“™ç¼ç†»î…¸ç’â„ƒæšŸé£?

```rust    stats_successful: Arc<AtomicU64>,

pub struct WorkStealingScheduler {    stats_failed: Arc<AtomicU64>,

    injector: Arc<Injector<Task>>,       // å…¨å±€ä»»åŠ¡é˜Ÿåˆ—    stats_rollback: Arc<AtomicU64>,

    stealers: Vec<Stealer<Task>>,        // çªƒå–å™¨åˆ—è¡¨    stats_retry: Arc<AtomicU64>,

    scheduler: Arc<ParallelScheduler>,   // åº•å±‚è°ƒåº¦å™¨    stats_conflict: Arc<AtomicU64>,

    num_workers: usize,                  // å·¥ä½œçº¿ç¨‹æ•°}

}```



pub struct Task {**éç¨¿ç¸¾é‚è§„ç¡¶**:

    pub tx_id: TxId,- `execute_with_snapshot<F>()`: è¹‡î‚¤åæ·‡æ¿‡å§¢éµÑ†î”‘

    pub priority: u8,  // 0-255,è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜- `execute_with_retry<F>(max_retries)`: é‘·î„å§©é–²å¶ˆç˜¯éµÑ†î”‘

}- `execute_batch(ops)`: éµå½’å™ºéµÑ†î”‘æ¶“â‚¬ç¼å‹ªæ°¦é„æ“„ç´é˜ç†·ç“™é»æ„ªæ°¦/é¥ç‚´ç²´

```- `batch_write/read/delete(...)`: éµå½’å™ºç€›æ¨ºåé¿å¶„ç¶”é”›å²„æª·æµ£åº¨æ”£æµœå¤Œæ•¤

- `get_parallel_batch()`: é‘¾å³°å½‡é™îˆšè‹Ÿç›å±¼æ°¦é„?

**å·¥ä½œåŸç†**:- `get_stats()`: é‘¾å³°å½‡éµÑ†î”‘ç¼ç†»î…¸

1. æ¯ä¸ªå·¥ä½œçº¿ç¨‹æœ‰è‡ªå·±çš„**æœ¬åœ°é˜Ÿåˆ—** (FIFO)

2. çº¿ç¨‹é¦–å…ˆä»æœ¬åœ°é˜Ÿåˆ—è·å–ä»»åŠ¡---

3. æœ¬åœ°é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œä»**å…¨å±€é˜Ÿåˆ—**æ‰¹é‡è·å–

4. å…¨å±€é˜Ÿåˆ—ä¹Ÿä¸ºç©ºæ—¶ï¼Œä»å…¶ä»–çº¿ç¨‹**çªƒå–**ä»»åŠ¡### 7. WorkStealingScheduler (å®¸ãƒ¤ç¶”ç»å†¨å½‡ç’‹å†¨å®³é£?

5. ä½¿ç”¨ Rayon çº¿ç¨‹æ± å®ç°å¹¶è¡Œæ‰§è¡Œ

**é¢ã„©â‚¬?*: æµ£è·¨æ•¤å®¸ãƒ¤ç¶”ç»å†¨å½‡ç» æ¥ç¡¶ç€¹ç‚µå¹‡ç’ç†»æµ‡é§å›ªã€€é¨å‹«è‹Ÿç›å²ƒçšŸæ´?

**æ ¸å¿ƒæ–¹æ³•**:

- `new(num_workers)`: åˆ›å»ºè°ƒåº¦å™¨```rust

- `submit_task(task)`: æäº¤å•ä¸ªä»»åŠ¡pub struct WorkStealingScheduler {

- `submit_tasks(tasks)`: æ‰¹é‡æäº¤ä»»åŠ¡    injector: Arc<Injector<Task>>,       // éã„¥çœ¬æµ è¯²å§Ÿé—ƒç†·åª

- `execute_all<F>(executor)`: å¹¶è¡Œæ‰§è¡Œæ‰€æœ‰ä»»åŠ¡    stealers: Vec<Stealer<Task>>,        // ç»å†¨å½‡é£ã„¥åªç›?

- `get_scheduler()`: è·å–åº•å±‚ ParallelScheduler    scheduler: Arc<ParallelScheduler>,   // æ´æ›çœ°ç’‹å†¨å®³é£?

- `get_stats()`: è·å–æ‰§è¡Œç»Ÿè®¡    num_workers: usize,                  // å®¸ãƒ¤ç¶”ç»¾è·¨â–¼é?

}

**ä¼˜åŠ¿**:

- âœ… **è´Ÿè½½å‡è¡¡**: è‡ªåŠ¨å¹³è¡¡çº¿ç¨‹é—´çš„å·¥ä½œé‡pub struct Task {

- âœ… **é«˜ååé‡**: å‡å°‘çº¿ç¨‹ç©ºé—²æ—¶é—´    pub tx_id: TxId,

- âœ… **å¯æ‰©å±•æ€§**: æ”¯æŒä»»æ„æ•°é‡çš„å·¥ä½œçº¿ç¨‹    pub priority: u8,  // 0-255,ç“’å©‚ã‡æµ¼æ¨ºå›ç»¾Ñ†ç§ºæ¥‚?

- âœ… **ä¼˜å…ˆçº§æ”¯æŒ**: å¯æŒ‰ä¼˜å…ˆçº§è°ƒåº¦ä»»åŠ¡}

```

---

**å®¸ãƒ¤ç¶”é˜ç†ºæ‚Š**:

### 8. Batch Operations (æ‰¹é‡æ“ä½œ)1. å§£å¿é‡œå®¸ãƒ¤ç¶”ç»¾è·¨â–¼éˆå¤åšœå®¸è¾©æ®‘**éˆî„€æ¹´é—ƒç†·åª** (FIFO)

2. ç»¾è·¨â–¼æ££æ §å›æµ åº¢æ¹°é¦ä¼´æ§¦é’æ¥„å¹é™æ ¦æ¢é”?

**åŠ¨æœº**: æ‰¹é‡åŒ–å‡å°‘é”è·å–ä¸å¿«ç…§åˆ›å»º/æäº¤çš„æ¬¡æ•°ï¼Œæå‡é«˜å¹¶å‘åœºæ™¯ä¸‹çš„ååé‡ã€‚3. éˆî„€æ¹´é—ƒç†·åªæ¶“è™¹â”–éƒ?æµ ?*éã„¥çœ¬é—ƒç†·åª**éµå½’å™ºé‘¾å³°å½‡

4. éã„¥çœ¬é—ƒç†·åªæ¶”ç†¶è´Ÿç»Œçƒ˜æ¤‚,æµ åº¡å¾æµ æ «åšç»‹?*ç»å†¨å½‡**æµ è¯²å§Ÿ

**StateManager æ‰¹é‡ API**:5. æµ£è·¨æ•¤ Rayon ç»¾è·¨â–¼å§¹çŠ²ç–„éœæ¿è‹Ÿç›å±¾å¢½ç›?

- `batch_write(Vec<(Vec<u8>, Vec<u8>)>) -> usize`

- `batch_read(&[Vec<u8>]) -> Vec<(Vec<u8>, Vec<u8>)>`**éç¨¿ç¸¾é‚è§„ç¡¶**:

- `batch_delete(&[Vec<u8>]) -> usize`- `new(num_workers)`: é’æ¶˜ç¼“ç’‹å†¨å®³é£?

- `batch_emit_events(Vec<Vec<u8>>) -> usize`- `submit_task(task)`: é»æ„ªæ°¦é—æ›šé‡œæµ è¯²å§Ÿ

- `submit_tasks(tasks)`: éµå½’å™ºé»æ„ªæ°¦æµ è¯²å§Ÿ

**ParallelScheduler æ‰¹é‡ API**:- `execute_all<F>(executor)`: éªæƒ°î”‘éµÑ†î”‘éµâ‚¬éˆå¤‰æ¢é”?

- `execute_batch<Vec<T>>(Vec<F>)`: åœ¨å•ä¸€å¿«ç…§ä¸­æ‰§è¡Œå¤šç¬”äº¤æ˜“ï¼Œä»»ä¸€å¤±è´¥åˆ™æ•´æ‰¹å›æ»š- `get_scheduler()`: é‘¾å³°å½‡æ´æ›çœ° ParallelScheduler

- ç›´é€šæ‰¹é‡å­˜å‚¨æ¥å£ï¼š`batch_write/read/delete`- `get_stats()`: é‘¾å³°å½‡éµÑ†î”‘ç¼ç†»î…¸



**ç¤ºä¾‹**:**æµ¼æ¨ºå¨**:

```rust- é‰?**ç’ç†»æµ‡é§å›ªã€€**: é‘·î„å§©éªå® ã€€ç»¾è·¨â–¼é—‚å¯¸æ®‘å®¸ãƒ¤ç¶”é–²?

// æ‰¹é‡æ‰§è¡Œä¸‰ç¬”è½¬è´¦ï¼Œä»»ä¸€å¤±è´¥åˆ™æ•´æ‰¹å›æ»š- é‰?**æ¥‚æ¨ºæ‚¶éšæ„°å™º**: é‘å¿“çš¯ç»¾è·¨â–¼ç»Œæ´ªæ£½éƒå •æ£¿

let results = scheduler.execute_batch(vec![- é‰?**é™îˆ›å¢¿çæ›Ÿâ‚¬?*: é€îˆ›å¯”æµ ç»˜å‰°éä¼´å™ºé¨å‹«ä¼æµ£æ»…åšç»‹?

    Box::new(|m: &StateManager| { /* tx1 */ Ok(1) }) as Box<dyn FnOnce(&StateManager) -> Result<i32, String>>,- é‰?**æµ¼æ¨ºå›ç»¾Ñ„æ•®é¸?*: é™îˆ›å¯œæµ¼æ¨ºå›ç»¾Ñ†çšŸæ´ï¸¿æ¢é”?

    Box::new(|m: &StateManager| { /* tx2 */ Ok(2) }),

    Box::new(|m: &StateManager| { /* tx3 */ Ok(3) }),---

])?;

```### 8. Batch Operations (éµå½’å™ºé¿å¶„ç¶”)



---**é”ã„¦æº€**: éµå½’å™ºé–æ §å™ºçæˆ¦æ”£é‘¾å³°å½‡æ¶“åº¡æ©é“Ñƒå±å¯¤?é»æ„ªæ°¦é¨å‹¬î‚¼éå¸®ç´é»æ„¬å´Œæ¥‚æ¨ºè‹Ÿé™æˆæº€é…îˆ™ç¬…é¨å‹«æ‚¶éšæ„°å™ºéŠ†?



## å…³é”® API**StateManager éµå½’å™º API**:

- `batch_write(Vec<(Vec<u8>, Vec<u8>)>) -> usize`

### åŸºç¡€ä½¿ç”¨- `batch_read(&[Vec<u8>]) -> Vec<(Vec<u8>, Vec<u8>)>`

- `batch_delete(&[Vec<u8>]) -> usize`

```rust- `batch_emit_events(Vec<Vec<u8>>) -> usize`

use vm_runtime::ParallelScheduler;

**ParallelScheduler éµå½’å™º API**:

// åˆ›å»ºè°ƒåº¦å™¨- `execute_batch<Vec<T>>(Vec<F>)`: é¦ã„¥å´Ÿæ¶“â‚¬è¹‡î‚¤åæ¶“î…Ÿå¢½ç›å±½î˜¿ç»—æ–¾æ°¦é„æ“„ç´æµ è®³ç«´æ¾¶è¾«è§¦é’æ¬æš£éµç‘°æ´–å©Š?

let scheduler = ParallelScheduler::new();- é©æ’®â‚¬æ°­å£’é–²å¿“ç“¨éŒã„¦å¸´é™ï½ç´°`batch_write/read/delete`



// ä½¿ç”¨å¿«ç…§ä¿æŠ¤æ‰§è¡Œäº¤æ˜“**ç»€è½°ç·¥**:

let result = scheduler.execute_with_snapshot(|manager| {```rust

    let storage = manager.get_storage();// éµå½’å™ºéµÑ†î”‘æ¶“å¤Œç‘ªæî„ƒå¤„é”›å±¼æ¢æ¶“â‚¬æ¾¶è¾«è§¦é’æ¬æš£éµç‘°æ´–å©Š?

    let mut storage = storage.lock().unwrap();let results = scheduler.execute_batch(vec![

        Box::new(|m: &StateManager| { /* tx1 */ Ok(1) }) as Box<dyn FnOnce(&StateManager) -> Result<i32, String>>,

    // æ‰§è¡Œäº¤æ˜“é€»è¾‘    Box::new(|m: &StateManager| { /* tx2 */ Ok(2) }),

    storage.insert(b"balance".to_vec(), b"100".to_vec());    Box::new(|m: &StateManager| { /* tx3 */ Ok(3) }),

    ])?;

    Ok(()) // è¿”å› Ok åˆ™æäº¤ï¼ŒErr åˆ™å›æ»š```

})?;

```---



### è‡ªåŠ¨é‡è¯•## API é™å‚â‚¬?



```rust### é©è™¹î”…æµ£è·¨æ•¤

// å¤±è´¥æ—¶è‡ªåŠ¨é‡è¯•

let result = scheduler.execute_with_retry(```rust

    |manager| {use vm_runtime::ParallelScheduler;

        // å¯èƒ½å¤±è´¥çš„æ“ä½œ

        if some_condition() {// é’æ¶˜ç¼“ç’‹å†¨å®³é£?

            return Err("Temporary failure".to_string());let scheduler = ParallelScheduler::new();

        }

        Ok(42)// æµ£è·¨æ•¤è¹‡î‚¤åæ·‡æ¿‡å§¢éµÑ†î”‘æµœã‚†æ§—

    },let result = scheduler.execute_with_snapshot(|manager| {

    max_retries: 3  // æœ€å¤šé‡è¯• 3 æ¬¡    let storage = manager.get_storage();

)?;    let mut storage = storage.lock().unwrap();

```    

    // éµÑ†î”‘æµœã‚†æ§—é–«æ˜ç·«

### è·å–ç»Ÿè®¡    storage.insert(b"balance".to_vec(), b"100".to_vec());

    

```rust    Ok(()) // æ©æ–¿æ´– Ok é’æ¬å½æµœã‚ç´Err é’æ¬æ´–å©Š?

let stats = scheduler.get_stats();})?;

```

println!("æ€»äº¤æ˜“æ•°: {}", stats.total_txs());

println!("æˆåŠŸç‡: {:.2}%", stats.success_rate() * 100.0);### é‘·î„å§©é–²å¶ˆç˜¯

println!("å›æ»šç‡: {:.2}%", stats.rollback_rate() * 100.0);

println!("é‡è¯•æ¬¡æ•°: {}", stats.retry_count);```rust

```// æ¾¶è¾«è§¦éƒæƒ°åšœé”ã„©å™¸ç’‡?

let result = scheduler.execute_with_retry(

### å¹¶è¡Œæ‰¹æ¬¡è°ƒåº¦    |manager| {

        // é™îˆå…˜æ¾¶è¾«è§¦é¨å‹¬æ·æµ£?

```rust        if some_condition() {

use vm_runtime::{ReadWriteSet, ConflictDetector};            return Err("Temporary failure".to_string());

        }

let scheduler = ParallelScheduler::new();        Ok(42)

    },

// è®°å½•äº¤æ˜“è¯»å†™é›†    max_retries: 3  // éˆâ‚¬æ¾¶æ°¶å™¸ç’‡?3 å¨†?

for (tx_id, rw_set) in transactions {)?;

    scheduler.record_rw_set(tx_id, rw_set);```

}

### é‘¾å³°å½‡ç¼ç†»î…¸

// è·å–å¯å¹¶è¡Œæ‰§è¡Œçš„äº¤æ˜“

let all_txs: Vec<u64> = vec![1, 2, 3, 4, 5];```rust

let ready_txs = scheduler.get_parallel_batch(&all_txs);let stats = scheduler.get_stats();



// ready_txs åŒ…å«æ‰€æœ‰å¯ä»¥å¹¶è¡Œæ‰§è¡Œçš„äº¤æ˜“println!("é¬è®³æ°¦é„æ’´æšŸ: {}", stats.total_txs());

println!("å¯å¹¶è¡Œæ‰§è¡Œ: {:?}", ready_txs);println!("é´æ„¬å§›éœ? {:.2}%", stats.success_rate() * 100.0);

```println!("é¥ç‚´ç²´éœ? {:.2}%", stats.rollback_rate() * 100.0);

println!("é–²å¶ˆç˜¯å¨†â„ƒæšŸ: {}", stats.retry_count);

### å·¥ä½œçªƒå–è°ƒåº¦```



```rust### éªæƒ°î”‘éµè§„î‚¼ç’‹å†¨å®³

use vm_runtime::{WorkStealingScheduler, Task};

```rust

// åˆ›å»ºå·¥ä½œçªƒå–è°ƒåº¦å™¨(4 ä¸ªå·¥ä½œçº¿ç¨‹)use vm_runtime::{ReadWriteSet, ConflictDetector};

let scheduler = WorkStealingScheduler::new(Some(4));

let scheduler = ParallelScheduler::new();

// æäº¤ä»»åŠ¡

let tasks = vec![// ç’æ¿ç¶æµœã‚†æ§—ç’‡è¯²å•“é—†?

    Task::new(1, 255),  // é«˜ä¼˜å…ˆçº§for (tx_id, rw_set) in transactions {

    Task::new(2, 128),  // ä¸­ä¼˜å…ˆçº§    scheduler.record_rw_set(tx_id, rw_set);

    Task::new(3, 50),   // ä½ä¼˜å…ˆçº§}

];

scheduler.submit_tasks(tasks);// é‘¾å³°å½‡é™îˆšè‹Ÿç›å±¾å¢½ç›å²€æ®‘æµœã‚†æ§—

let all_txs: Vec<u64> = vec![1, 2, 3, 4, 5];

// å¹¶è¡Œæ‰§è¡Œæ‰€æœ‰ä»»åŠ¡let ready_txs = scheduler.get_parallel_batch(&all_txs);

let result = scheduler.execute_all(|tx_id| {

    // æ‰§è¡Œä»»åŠ¡é€»è¾‘// ready_txs é–å‘­æƒˆéµâ‚¬éˆå¤Šå½²æµ ãƒ¥è‹Ÿç›å±¾å¢½ç›å²€æ®‘æµœã‚†æ§—

    println!("Processing transaction {}", tx_id);println!("é™îˆšè‹Ÿç›å±¾å¢½ç›? {:?}", ready_txs);

    Ok(())```

})?;

### å®¸ãƒ¤ç¶”ç»å†¨å½‡ç’‹å†¨å®³

println!("Executed: {:?}", result);

``````rust

use vm_runtime::{WorkStealingScheduler, Task};

---

// é’æ¶˜ç¼“å®¸ãƒ¤ç¶”ç»å†¨å½‡ç’‹å†¨å®³é£?(4 æ¶“î„ä¼æµ£æ»…åšç»‹?

## ç¤ºä¾‹let scheduler = WorkStealingScheduler::new(Some(4));



### ç¤ºä¾‹ 1: è½¬è´¦äº¤æ˜“// é»æ„ªæ°¦æµ è¯²å§Ÿ

let tasks = vec![

```rust    Task::new(1, 255),  // æ¥‚æ¨¹ç´­éå ¢éª‡

use vm_runtime::ParallelScheduler;    Task::new(2, 128),  // æ¶“î…ç´­éå ¢éª‡

    Task::new(3, 50),   // æµ£åºç´­éå ¢éª‡

let scheduler = ParallelScheduler::new();];

scheduler.submit_tasks(tasks);

// Alice è½¬è´¦ç»™ Bob

let result = scheduler.execute_with_snapshot(|manager| {// éªæƒ°î”‘éµÑ†î”‘éµâ‚¬éˆå¤‰æ¢é”?

    let storage = manager.get_storage();let result = scheduler.execute_all(|tx_id| {

    let mut storage = storage.lock().unwrap();    // éµÑ†î”‘æµ è¯²å§Ÿé–«æ˜ç·«

        println!("Processing transaction {}", tx_id);

    // è¯»å– Alice ä½™é¢    Ok(())

    let alice_balance: u64 = storage.get(b"alice")})?;

        .and_then(|b| String::from_utf8(b.clone()).ok())

        .and_then(|s| s.parse().ok())println!("Executed: {:?}", result);

        .unwrap_or(0);```

    

    // æ£€æŸ¥ä½™é¢---

    if alice_balance < 50 {

        return Err("Insufficient balance".to_string());## æµ£è·¨æ•¤ç»€è½°ç·¥

    }

    ### ç»€è½°ç·¥ 1: æî„ƒå¤„æµœã‚†æ§—

    // æ›´æ–°ä½™é¢

    storage.insert(b"alice".to_vec(), (alice_balance - 50).to_string().into_bytes());```rust

    use vm_runtime::ParallelScheduler;

    let bob_balance: u64 = storage.get(b"bob")

        .and_then(|b| String::from_utf8(b.clone()).ok())let scheduler = ParallelScheduler::new();

        .and_then(|s| s.parse().ok())

        .unwrap_or(0);// Alice æî„ƒå¤„ç¼?Bob

    let result = scheduler.execute_with_snapshot(|manager| {

    storage.insert(b"bob".to_vec(), (bob_balance + 50).to_string().into_bytes());    let storage = manager.get_storage();

        let mut storage = storage.lock().unwrap();

    Ok(())    

})?;    // ç’‡è¯²å½‡ Alice æµ£æ¬“î–‚

```    let alice_balance: u64 = storage.get(b"alice")

        .and_then(|b| String::from_utf8(b.clone()).ok())

### ç¤ºä¾‹ 2: å†²çªæ£€æµ‹        .and_then(|s| s.parse().ok())

        .unwrap_or(0);

```rust    

use vm_runtime::{ReadWriteSet, ConflictDetector};    // å¦«â‚¬éŒãƒ¤ç¶‘æ£°?

    if alice_balance < 50 {

let mut detector = ConflictDetector::new();        return Err("Insufficient balance".to_string());

    }

// äº¤æ˜“ 1: Alice -> Bob    

let mut tx1_rw = ReadWriteSet::new();    // é‡å­˜æŸŠæµ£æ¬“î–‚

tx1_rw.add_read(b"alice".to_vec());    storage.insert(b"alice".to_vec(), (alice_balance - 50).to_string().into_bytes());

tx1_rw.add_write(b"alice".to_vec());    

tx1_rw.add_write(b"bob".to_vec());    let bob_balance: u64 = storage.get(b"bob")

detector.record(1, tx1_rw);        .and_then(|b| String::from_utf8(b.clone()).ok())

        .and_then(|s| s.parse().ok())

// äº¤æ˜“ 2: Bob -> Charlie (ä¸ tx1 å†²çª)        .unwrap_or(0);

let mut tx2_rw = ReadWriteSet::new();    

tx2_rw.add_read(b"bob".to_vec());   // è¯» bobï¼Œä¸ tx1 å†™å†²çª    storage.insert(b"bob".to_vec(), (bob_balance + 50).to_string().into_bytes());

tx2_rw.add_write(b"bob".to_vec());    

tx2_rw.add_write(b"charlie".to_vec());    Ok(())

detector.record(2, tx2_rw);})?;

```

// äº¤æ˜“ 3: David -> Eve (æ— å†²çª)

let mut tx3_rw = ReadWriteSet::new();### ç»€è½°ç·¥ 2: éèŒ¬çŠå¦«â‚¬å¨´?

tx3_rw.add_write(b"david".to_vec());

tx3_rw.add_write(b"eve".to_vec());```rust

detector.record(3, tx3_rw);use vm_runtime::{ReadWriteSet, ConflictDetector};



// æ£€æµ‹å†²çªlet mut detector = ConflictDetector::new();

assert!(detector.has_conflict(1, 2));  // tx1 å’Œ tx2 å†²çª

assert!(!detector.has_conflict(1, 3)); // tx1 å’Œ tx3 ä¸å†²çª// æµœã‚†æ§— 1: Alice -> Bob

assert!(!detector.has_conflict(2, 3)); // tx2 å’Œ tx3 ä¸å†²çªlet mut tx1_rw = ReadWriteSet::new();

tx1_rw.add_read(b"alice".to_vec());

// tx1 å’Œ tx3 å¯ä»¥å¹¶è¡Œæ‰§è¡Œï¼Œtx2 å¿…é¡»ç­‰å¾… tx1tx1_rw.add_write(b"alice".to_vec());

```tx1_rw.add_write(b"bob".to_vec());

detector.record(1, tx1_rw);

### ç¤ºä¾‹ 3: åµŒå¥—å¿«ç…§

// æµœã‚†æ§— 2: Bob -> Charlie (æ¶“?tx1 éèŒ¬çŠ)

```rustlet mut tx2_rw = ReadWriteSet::new();

let scheduler = ParallelScheduler::new();tx2_rw.add_read(b"bob".to_vec());   // ç’‡?bobé”›å±¼ç¬Œ tx1 éæ¬å•¿ç»?

tx2_rw.add_write(b"bob".to_vec());

// å¤–å±‚äº¤æ˜“tx2_rw.add_write(b"charlie".to_vec());

scheduler.execute_with_snapshot(|manager| {detector.record(2, tx2_rw);

    let storage = manager.get_storage();

    let mut storage = storage.lock().unwrap();// æµœã‚†æ§— 3: David -> Eve (éƒçŠ²å•¿ç»?

    storage.insert(b"level".to_vec(), b"1".to_vec());let mut tx3_rw = ReadWriteSet::new();

    tx3_rw.add_write(b"david".to_vec());

    // å¯ä»¥åœ¨è¿™é‡Œæ‰§è¡Œæ›´å¤šåµŒå¥—äº¤æ˜“tx3_rw.add_write(b"eve".to_vec());

    // æ¯ä¸ªéƒ½æœ‰è‡ªå·±çš„å¿«ç…§detector.record(3, tx3_rw);

    

    Ok(())// å¦«â‚¬å¨´å¬ªå•¿ç»?

})?;assert!(detector.has_conflict(1, 2));  // tx1 éœ?tx2 éèŒ¬çŠ

```assert!(!detector.has_conflict(1, 3)); // tx1 éœ?tx3 æ¶“å¶…å•¿ç»?

assert!(!detector.has_conflict(2, 3)); // tx2 éœ?tx3 æ¶“å¶…å•¿ç»?

---

// tx1 éœ?tx3 é™îˆ™äº’éªæƒ°î”‘éµÑ†î”‘é”›å®¼x2 è¹‡å‘´ã€ç»›å¤Šç·Ÿ tx1

## æ€§èƒ½ä¼˜åŒ–```



### 1. æœ€å°åŒ–é”äº‰ç”¨### ç»€è½°ç·¥ 3: å®“å±½îšœè¹‡î‚¤å



```rust```rust

// âŒ ä¸å¥½ - é•¿æ—¶é—´æŒæœ‰é”let scheduler = ParallelScheduler::new();

let mut storage = manager.get_storage().lock().unwrap();

expensive_computation();// æ¾¶æ §çœ°æµœã‚†æ§—

storage.insert(...);scheduler.execute_with_snapshot(|manager| {

    let storage = manager.get_storage();

// âœ… å¥½ - åªåœ¨å¿…è¦æ—¶æŒæœ‰é”    let mut storage = storage.lock().unwrap();

let data = expensive_computation();    storage.insert(b"level".to_vec(), b"1".to_vec());

{    

    let storage = manager.get_storage();    // é™îˆ™äº’é¦ã„¨ç¹–é–²å±¾å¢½ç›å±¾æ´¿æ¾¶æ°¬ç¥µæ¿‚æ¤¾æ°¦é„?

    let mut storage = storage.lock().unwrap();    // å§£å¿é‡œé–®èŠ¥æ¹é‘·î„ç¹é¨å‹«æ©é“?

    storage.insert(...);    

}    Ok(())

```})?;

```

### 2. æ‰¹é‡æ“ä½œ

---

```rust

// æ‰¹é‡è®°å½•è¯»å†™é›†## é¬Ñ†å…˜æµ¼æ¨ºå¯²

for (tx_id, rw_set) in transactions.iter() {

    scheduler.record_rw_set(*tx_id, rw_set.clone());### 1. éˆâ‚¬çå¿“å¯²é–¿ä½·ç°¤é¢?

}

```rust

// ä¸€æ¬¡æ€§è·å–å¯å¹¶è¡Œæ‰¹æ¬¡// é‰‚?æ¶“å¶…ã‚½ - é—€æŒæ¤‚é—‚å­˜å¯”éˆå¤æ”£

let ready_batch = scheduler.get_parallel_batch(&all_tx_ids);let mut storage = manager.get_storage().lock().unwrap();

```expensive_computation();

storage.insert(...);

### 3. é¿å…ä¸å¿…è¦çš„å¿«ç…§

// é‰?æ¿‚?- é™î„æ¹ªè¹‡å‘°î›¦éƒèˆµå¯”éˆå¤æ”£

```rustlet data = expensive_computation();

// åªè¯»æ“ä½œä¸éœ€è¦å¿«ç…§{

let storage = scheduler.get_storage();    let storage = manager.get_storage();

let storage = storage.lock().unwrap();    let mut storage = storage.lock().unwrap();

let value = storage.get(b"key");    storage.insert(...);

}

// å†™æ“ä½œæ‰éœ€è¦å¿«ç…§ä¿æŠ¤```

scheduler.execute_with_snapshot(|manager| {

    // ä¿®æ”¹çŠ¶æ€### 2. éµå½’å™ºé¿å¶„ç¶”

    Ok(())

})?;```rust

```// éµå½’å™ºç’æ¿ç¶ç’‡è¯²å•“é—†?

for (tx_id, rw_set) in transactions.iter() {

### 4. å¸¸è§ç“¶é¢ˆåˆ†æ    scheduler.record_rw_set(*tx_id, rw_set.clone());

}

- **é”ç«äº‰ï¼ˆMutex äº‰ç”¨ï¼‰**

    - ç—‡çŠ¶: é«˜å¹¶å‘ä¸‹å»¶è¿ŸæŠ–åŠ¨ã€å°¾å»¶è¿Ÿä¸Šå‡// æ¶“â‚¬å¨†â„ƒâ‚¬Ñ†å¹é™æ §å½²éªæƒ°î”‘éµè§„î‚¼

    - ç¼“è§£: é‡‡ç”¨æ‰¹é‡è¯»å†™ã€ç¼©çŸ­æŒé”åŒºé—´ã€å¿…è¦æ—¶ç»†åŒ–é”ç²’åº¦let ready_batch = scheduler.get_parallel_batch(&all_tx_ids);

- **å¿«ç…§åˆ›å»º/å›æ»šå¼€é”€**```

    - ç—‡çŠ¶: å¤§äº‹åŠ¡æˆ–æ·±åº¦åµŒå¥—æ—¶è€—æ—¶ä¸Šå‡

    - ç¼“è§£: åˆç†åˆ†æ‰¹ã€å‡å°‘ä¸å¿…è¦çš„åµŒå¥—ã€å°†åªè¯»è·¯å¾„ç§»å‡ºå¿«ç…§### 3. é–¬å®å¤æ¶“å¶…ç¹€ç‘•ä½ºæ®‘è¹‡î‚¤å

- **ä¾èµ–å›¾è¿‡åº¦å¯†é›†**

    - ç—‡çŠ¶: å¯å¹¶è¡Œåº¦ä¸‹é™ã€æ‰¹æ¬¡å˜å°```rust

    - ç¼“è§£: é€šè¿‡è¯»å†™é›†è®¾è®¡å‡å°‘äº¤å‰è®¿é—®ã€å¯¹çƒ­é—¨é”®åšåˆ†ç‰‡// é™î‡î‡°é¿å¶„ç¶”æ¶“å¶‰æ¸¶ç‘•ä½¸æ©é“?

- **è°ƒåº¦å¼€é”€ï¼ˆå·¥ä½œçªƒå–ï¼‰**let storage = scheduler.get_storage();

    - ç—‡çŠ¶: ä»»åŠ¡æçŸ­æ—¶è°ƒåº¦æˆæœ¬ç›¸å¯¹åé«˜let storage = storage.lock().unwrap();

    - ç¼“è§£: åˆå¹¶å°ä»»åŠ¡ä¸ºæ‰¹å¤„ç†ã€æå‡æ¯ä¸ªä»»åŠ¡çš„å·¥ä½œé‡let value = storage.get(b"key");



---// éæ¬æ·æµ£æ»„å¢ é—‡â‚¬ç‘•ä½¸æ©é“Ñ‚ç¹šé¶?

scheduler.execute_with_snapshot(|manager| {

## æµ‹è¯•ä¸åŸºå‡†    // æ·‡î†½æ•¼é˜èˆµâ‚¬?

    Ok(())

### å•å…ƒæµ‹è¯•è¦†ç›–})?;

```

**å†²çªæ£€æµ‹** (6 ä¸ªæµ‹è¯•):

- âœ… test_read_write_set_conflicts### 4. ç”¯æ­Œî†é¡å •î•­é’å—˜ç€½

- âœ… test_no_conflict

- âœ… test_dependency_graph- é–¿ä½ºçµæµœå¤›ç´™Mutex æµœå¤Œæ•¤é”›?

- âœ… test_conflict_detector    - é¥å›©å§¸: æ¥‚æ¨ºè‹Ÿé™æˆœç¬…å¯¤æƒ°ç¹œé¶æ §å§©éŠ†ä½¸ç†¬å¯¤æƒ°ç¹œæ¶“å©‚å´Œ

    - ç¼‚æ’¹Ğ’: é–²å›©æ•¤éµå½’å™ºé?ç’‡æ±‡â‚¬ä½ºç¼‰é­î…Ÿå¯”é–¿ä½¸å°¯é—‚æ·¬â‚¬ä½¸ç¹€ç‘•ä½¹æ¤‚ç¼å——å¯²é–¿ä½ºçŸ‘æ´?

**çŠ¶æ€å¿«ç…§** (5 ä¸ªæµ‹è¯•):- è¹‡î‚¤åé’æ¶˜ç¼“/é¥ç‚´ç²´å¯®â‚¬é–¿â‚¬

- âœ… test_snapshot_creation    - é¥å›©å§¸: æ¾¶Ñ‚ç°¨é”â„ƒå¨å¨£åå®³å®“å±½îšœéƒæƒ°â‚¬æ¥æ¤‚æ¶“å©‚å´Œ

- âœ… test_rollback    - ç¼‚æ’¹Ğ’: éšå ¢æ‚Šé’å—˜å£’éŠ†ä½¸å™ºçæˆœç¬‰è¹‡å‘°î›¦é¨å‹«ç¥µæ¿‚æ¤¼â‚¬ä½¸çš¢é™î‡î‡°ç’ºîˆšç·ç»‰è¯²åš­è¹‡î‚¤å

- âœ… test_nested_snapshots- æ¸šæ¿Šç¦†é¥æç¹ƒæ´ï¹€ç˜‘é—†?

- âœ… test_commit    - é¥å›©å§¸: é™îˆšè‹Ÿç›å±½å®³æ¶“å¬®æª·éŠ†ä½¹å£’å¨†â€³å½‰ç?

- âœ… test_snapshot_with_events    - ç¼‚æ’¹Ğ’: é–«æ°³ç¹ƒç’‡è¯²å•“é—†å—šî†•ç’â€³å™ºçæˆœæ°¦é™å¤î†–é—‚î†ºâ‚¬ä½¸î‡®é‘î…¢æ£¬é–¿î†¼ä»›é’å—™å¢–

- ç’‹å†¨å®³å¯®â‚¬é–¿â‚¬é”›å ä¼æµ£æ»…çŒé™æ µç´š

**è°ƒåº¦å™¨é›†æˆ** (3 ä¸ªæµ‹è¯•):    - é¥å›©å§¸: æµ è¯²å§Ÿé‹ä½ºç…­éƒæƒ°çšŸæ´ï¸½åšéˆî„‚æµ‰ç€µç‘°äº¸æ¥‚?

- âœ… test_scheduler_with_snapshot    - ç¼‚æ’¹Ğ’: éšå è‹Ÿçå¿æ¢é”â€²è´Ÿéµç‘°î˜©éå—â‚¬ä½¹å½é—å›¨ç˜¡æ¶“îƒæ¢é”ï¼„æ®‘å®¸ãƒ¤ç¶”é–²?

- âœ… test_scheduler_rollback_on_error

- âœ… test_scheduler_nested_transactions---



**ç»Ÿè®¡ä¸é‡è¯•** (3 ä¸ªæµ‹è¯•):## å¨´å¬­ç˜¯æ¥ å²ƒç˜‰

- âœ… test_execution_stats

- âœ… test_retry_mechanism### é—æ›å“å¨´å¬­ç˜¯ç‘•å—™æ´Š

- âœ… test_retry_exhausted

**éèŒ¬çŠå¦«â‚¬å¨´?* (6 æ¶“î…ç¥´ç’‡?:

### åŸºå‡†æµ‹è¯•- é‰?test_read_write_set_conflicts

- é‰?test_no_conflict

è¿è¡ŒåŸºå‡†æµ‹è¯•:- é‰?test_dependency_graph

```bash- é‰?test_conflict_detector

cargo bench --bench parallel_benchmark

```**é˜èˆµâ‚¬ä½¸æ©é“?* (5 æ¶“î…ç¥´ç’‡?:

- é‰?test_snapshot_creation

æµ‹è¯•åœºæ™¯:- é‰?test_rollback

1. **å†²çªæ£€æµ‹æ€§èƒ½**: 10/50/100/500 äº¤æ˜“- é‰?test_nested_snapshots

2. **å¿«ç…§æ“ä½œæ€§èƒ½**: 10/100/1000 æ•°æ®é¡¹- é‰?test_commit

3. **ä¾èµ–å›¾æ„å»º**: ä¸åŒå†²çªç‡- é‰?test_snapshot_with_events

4. **å¹¶è¡Œè°ƒåº¦**: æ‰¹æ¬¡å¤§å°ä¼˜åŒ–

**ç’‹å†¨å®³é£ã„©æ³¦é´?* (3 æ¶“î…ç¥´ç’‡?:

#### å¦‚ä½•é˜…è¯»æŠ¥å‘Š- é‰?test_scheduler_with_snapshot

- é‰?test_scheduler_rollback_on_error

- æ‰“å¼€ HTML æŠ¥å‘Š: `target/criterion/report/index.html`- é‰?test_scheduler_nested_transactions

- estimates.json å­—æ®µ:

    - mean/median: å¹³å‡/ä¸­ä½æ•°è€—æ—¶**ç¼ç†»î…¸æ¶“åº¨å™¸ç’‡?* (3 æ¶“î…ç¥´ç’‡?:

    - slope: çº¿æ€§æ‹Ÿåˆçš„è¶‹åŠ¿ä¼°è®¡- é‰?test_execution_stats

    - std_dev: æ ‡å‡†å·®ï¼ˆæŠ–åŠ¨ï¼‰- é‰?test_retry_mechanism

    - confidence_interval: ç½®ä¿¡åŒºé—´ï¼ˆé»˜è®¤ 95%ï¼‰- é‰?test_retry_exhausted

- å•ä½: ns/iterï¼ˆCriterion é»˜è®¤å•ä½ï¼‰

### é©å“„å™¯å¨´å¬­ç˜¯

#### ç¤ºä¾‹æŒ‡æ ‡ï¼ˆèŠ‚é€‰ï¼‰

æ©æ„¯î”‘é©å“„å™¯å¨´å¬­ç˜¯:

- å¹¶è¡Œè°ƒåº¦ get_parallel_batch/100: å¹³å‡çº¦ 350,045 ns/æ‰¹```bash

- å†²çªæ£€æµ‹ non_conflicting/100: å¹³å‡çº¦ 396,673 nscargo bench --bench parallel_benchmark

- å†²çªæ£€æµ‹ 50% å†²çª/100: å¹³å‡çº¦ 460,675 ns```

- å¿«ç…§åˆ›å»º create_snapshot/1000: å¹³å‡çº¦ 224,712 ns

- ä¾èµ–å›¾ build_and_query/100: å¹³å‡çº¦ 344,862 nså¨´å¬­ç˜¯é¦çƒ˜æ«™:

1. **éèŒ¬çŠå¦«â‚¬å¨´å¬«â‚¬Ñ†å…˜**: 10/50/100/500 æµœã‚†æ§—

---2. **è¹‡î‚¤åé¿å¶„ç¶”é¬Ñ†å…˜**: 10/100/1000 éç‰ˆåµæ¤¤?

3. **æ¸šæ¿Šç¦†é¥ç‚¬ç€¯å¯¤?*: æ¶“å¶…æ‚“éèŒ¬çŠéœ?

## æœ€ä½³å®è·µ4. **éªæƒ°î”‘ç’‹å†¨å®³**: éµè§„î‚¼æ¾¶Ñƒçš¬æµ¼æ¨ºå¯²



### 1. é”™è¯¯å¤„ç†#### æ¿¡å‚™ç¶é—ƒå‘°î‡°é¶ãƒ¥æ†¡



```rust- éµæ’³ç´‘ HTML é¶ãƒ¥æ†¡: `target/criterion/report/index.html`

match scheduler.execute_with_snapshot(|manager| {- estimates.json ç€›æ¥î†Œ:

    // äº¤æ˜“é€»è¾‘    - mean/median: éªå†²æ½/æ¶“î…ç¶…éæ‹Œâ‚¬æ¥æ¤‚

    Ok(())    - slope: ç»¾æŒâ‚¬Ñ„å«™éšå ¢æ®‘ç“’å¬ªå¨æµ¼æ‹Œî…¸

}) {    - std_dev: éå›§å™¯å®¸î‡†ç´™é¶æ §å§©é”›?

    Ok(_) => println!("âœ… äº¤æ˜“æˆåŠŸ"),    - confidence_interval: ç¼ƒî†»ä¿Šé–æ´ªæ£¿é”›å ¥ç²¯ç’?95%é”›?

    Err(e) => eprintln!("âŒ äº¤æ˜“å¤±è´¥: {}", e),- é—æ›šç¶…: ns/iteré”›åœ•riterion æ¦›æ¨¿î…»é—æ›šç¶…é”›?

}

```#### ç»€è½°ç·¥é¸å›¨çˆ£é”›å £å¦­é–«å¤›ç´š



### 2. ç›‘æ§ç»Ÿè®¡- éªæƒ°î”‘ç’‹å†¨å®³ get_parallel_batch/100: éªå†²æ½ç»¾?350,045 ns/éµ?

- éèŒ¬çŠå¦«â‚¬å¨´?non_conflicting/100: éªå†²æ½ç»¾?396,673 ns

```rust- éèŒ¬çŠå¦«â‚¬å¨´?50% éèŒ¬çŠ/100: éªå†²æ½ç»¾?460,675 ns

// å®šæœŸæ£€æŸ¥ç»Ÿè®¡ä¿¡æ¯- è¹‡î‚¤åé’æ¶˜ç¼“ create_snapshot/1000: éªå†²æ½ç»¾?224,712 ns

let stats = scheduler.get_stats();- æ¸šæ¿Šç¦†é¥?build_and_query/100: éªå†²æ½ç»¾?344,862 ns

if stats.rollback_rate() > 0.5 {

    eprintln!("âš ï¸  é«˜å›æ»šç‡: {:.2}%", stats.rollback_rate() * 100.0);---

}

```## éˆâ‚¬æµ£å†²ç–„ç’º?



### 3. é‡è¯•ç­–ç•¥### 1. é–¿æ¬’î‡¤æ¾¶å‹­æ‚Š



```rust```rust

// æ ¹æ®é”™è¯¯ç±»å‹å†³å®šæ˜¯å¦é‡è¯•match scheduler.execute_with_snapshot(|manager| {

let result = scheduler.execute_with_retry(    // æµœã‚†æ§—é–«æ˜ç·«

    |manager| {    Ok(())

        match try_transaction(manager) {}) {

            Ok(r) => Ok(r),    Ok(_) => println!("é‰?æµœã‚†æ§—é´æ„¬å§›"),

            Err(e) if e.is_retriable() => Err(e.to_string()),    Err(e) => eprintln!("é‰‚?æµœã‚†æ§—æ¾¶è¾«è§¦: {}", e),

            Err(e) => return Err(e.to_string()), // ä¸å¯é‡è¯•é”™è¯¯}

        }```

    },

    max_retries: 5### 2. é©æˆå¸¶ç¼ç†»î…¸

);

``````rust

// ç€¹æ°­æ¹¡å¦«â‚¬éŒãƒ§ç²ºç’â€²ä¿Šé­?

---let stats = scheduler.get_stats();

if stats.rollback_rate() > 0.5 {

## MVCC å­˜å‚¨åç«¯ (v0.5.0) ğŸ”’    eprintln!("éˆ¿ç‹…ç¬  æ¥‚æ¨ºæ´–å©Šæ°±å·¼: {:.2}%", stats.rollback_rate() * 100.0);

}

### ä»€ä¹ˆæ˜¯ MVCCï¼Ÿ```



MVCC (Multi-Version Concurrency Controlï¼Œå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶) æ˜¯ä¸€ç§å¹¶å‘æ§åˆ¶æ–¹æ³•ï¼Œå…è®¸å¤šä¸ªäº‹åŠ¡åŒæ—¶è®¿é—®æ•°æ®åº“è€Œä¸äº’ç›¸é˜»å¡ã€‚æ¯ä¸ªé”®ç»´æŠ¤å¤šä¸ªç‰ˆæœ¬ï¼Œäº‹åŠ¡è¯»å–å…¶å¯åŠ¨æ—¶åˆ»çš„å¿«ç…§ï¼Œå†™å…¥åˆ›å»ºæ–°ç‰ˆæœ¬ã€‚### 3. é–²å¶ˆç˜¯ç»›æ «æš



### ä½•æ—¶ä½¿ç”¨ MVCCï¼Ÿ```rust

// éè§„åµé–¿æ¬’î‡¤ç»«è¯²ç€·éå†²ç•¾é„îˆšæƒé–²å¶ˆç˜¯

**æ¨èä½¿ç”¨ MVCC çš„åœºæ™¯**:let result = scheduler.execute_with_retry(

- âœ… é«˜å¹¶å‘è¯»å†™æ··åˆè´Ÿè½½    |manager| {

- âœ… é•¿äº‹åŠ¡ä¸çŸ­äº‹åŠ¡æ··åˆ        match try_transaction(manager) {

- âœ… éœ€è¦å¿«ç…§éš”ç¦»è¯­ä¹‰            Ok(r) => Ok(r),

- âœ… æŸ¥è¯¢å¯†é›†å‹åº”ç”¨ï¼ˆä½¿ç”¨åªè¯»äº‹åŠ¡ä¼˜åŒ–ï¼‰            Err(e) if e.is_retriable() => Err(e.to_string()),

            Err(e) => return Err(e.to_string()), // æ¶“å¶…å½²é–²å¶ˆç˜¯é–¿æ¬’î‡¤

**æ¨èä½¿ç”¨ Snapshot çš„åœºæ™¯**:        }

- âœ… ç®€å•ä¸²è¡Œæ‰§è¡Œ    },

- âœ… çŸ­äº‹åŠ¡ä¸ºä¸»    max_retries: 5

- âœ… å†…å­˜æ•æ„Ÿåœºæ™¯ï¼ˆMVCC ä¼šä¿ç•™å¤šç‰ˆæœ¬ï¼‰);

- âœ… ä¸éœ€è¦é«˜å¹¶å‘```



### åˆ›å»º MVCC è°ƒåº¦å™¨---



```rust## MVCC ç€›æ¨ºåéšåº£î¬ (v0.5.0) é¦ƒæ”¼

use vm_runtime::{ParallelScheduler, MvccStore};

use std::sync::Arc;### æµ â‚¬æ¶”å Ÿæ§¸ MVCCé”›?



// åˆ›å»º MVCC å­˜å‚¨MVCC (Multi-Version Concurrency Controlé”›å±½î˜¿é—å Ÿæ¹°éªè·ºå½‚éºÑƒåŸ—) é„îˆ™ç«´ç»‰å¶…è‹Ÿé™æˆå¸¶é’èˆµæŸŸå¨‰æ›ªç´éä½½î†æ¾¶æ°«é‡œæµœå¬ªå§Ÿéšå±¾æ¤‚ç’å—æ£¶éç‰ˆåµæ´æ’¹â‚¬å±¼ç¬‰æµœæ”æµ‰é—ƒè¯²î”£éŠ†å‚›ç˜¡æ¶“îˆæ•­ç¼å­˜å§¢æ¾¶æ°«é‡œé—å Ÿæ¹°é”›å±¼ç°¨é”Â¤î‡°é™æ §å¾éšîˆšå§©éƒè·ºåŸ¢é¨å‹«æ©é“Ñç´éæ¬å†é’æ¶˜ç¼“é‚æ‰®å¢—éˆîƒ¾â‚¬?

let mvcc_store = Arc::new(MvccStore::new());

### æµ£æ›Ÿæ¤‚æµ£è·¨æ•¤ MVCCé”›?

// åˆ›å»ºä½¿ç”¨ MVCC åç«¯çš„è°ƒåº¦å™¨

let scheduler = ParallelScheduler::new_with_mvcc(Arc::clone(&mvcc_store));**éºã„¨å´˜æµ£è·¨æ•¤ MVCC é¨å‹«æº€é…?*:

- é‰?æ¥‚æ¨ºè‹Ÿé™æˆ£î‡°éæ¬è´©éšå £ç¤‹æ?

// æ‰§è¡Œè¯»å†™äº‹åŠ¡- é‰?é—€å¤¸ç°¨é”â€²ç¬Œé­î…ç°¨é”â„ƒè´©éš?

scheduler.execute_with_mvcc(|txn| {- é‰?é—‡â‚¬ç‘•ä½¸æ©é“Ñ‡æ®§ç»‚æ˜î‡¢æ¶”?

    // è¯»å–æ•°æ®- é‰?éŒãƒ¨î‡—ç€µå—›æ³¦é¨å¬ªç°²é¢îŸ’ç´™æµ£è·¨æ•¤é™î‡î‡°æµœå¬ªå§Ÿæµ¼æ¨ºå¯²é”›?

    if let Some(balance) = txn.read(b"balance") {

        println!("Balance: {:?}", balance);**éºã„¨å´˜æµ£è·¨æ•¤ Snapshot é¨å‹«æº€é…?*:

    }- é‰?ç» â‚¬é—æ›šè¦†ç›å±¾å¢½ç›?

    - é‰?é­î…ç°¨é”â€²è´Ÿæ¶“?

    // å†™å…¥æ•°æ®ï¼ˆæœ¬åœ°ç¼“å­˜ï¼‰- é‰?éå‘­ç“¨éå¿”åŠ…é¦çƒ˜æ«™é”›åœ¡VCC æµ¼æ°«ç¹šé£æ¬î˜¿é—å Ÿæ¹°é”›?

    txn.write(b"balance".to_vec(), b"100".to_vec());- é‰?æ¶“å¶‰æ¸¶ç‘•ä¾€ç®éªè·ºå½‚

    

    // æˆåŠŸè¿”å›ï¼Œè‡ªåŠ¨æäº¤### é’æ¶˜ç¼“ MVCC ç’‹å†¨å®³é£?

    Ok(())

})?;```rust

use vm_runtime::{ParallelScheduler, MvccStore};

// æ‰§è¡Œåªè¯»äº‹åŠ¡ï¼ˆå¿«é€Ÿè·¯å¾„ï¼Œæ— å†²çªæ£€æµ‹ï¼‰use std::sync::Arc;

let result = scheduler.execute_with_mvcc_read_only(|txn| {

    let balance = txn.read(b"balance")?// é’æ¶˜ç¼“ MVCC ç€›æ¨ºå

        .ok_or("Balance not found")?;let mvcc_store = Arc::new(MvccStore::new());

    

    Ok(balance)// é’æ¶˜ç¼“æµ£è·¨æ•¤ MVCC éšåº£î¬é¨å‹®çšŸæ´ï¹€æ«’

})?;let scheduler = ParallelScheduler::new_with_mvcc(Arc::clone(&mvcc_store));

```

// éµÑ†î”‘ç’‡è¯²å•“æµœå¬ªå§Ÿ

### MVCC ç‰¹æ€§scheduler.execute_with_mvcc(|txn| {

    // ç’‡è¯²å½‡éç‰ˆåµ

**å¿«ç…§éš”ç¦» (Snapshot Isolation)**:    if let Some(balance) = txn.read(b"balance") {

- æ¯ä¸ªäº‹åŠ¡çœ‹åˆ°å¯åŠ¨æ—¶åˆ»çš„æ•°æ®å¿«ç…§        println!("Balance: {:?}", balance);

- è¯»å–ä¸ä¼šè¢«å†™å…¥é˜»å¡    }

- å†™å…¥ä¸ä¼šé˜»å¡è¯»å–    

    // éæ¬å†éç‰ˆåµé”›å Ÿæ¹°é¦æ‰®ç´¦ç€›æ©ˆç´š

**å†™å†™å†²çªæ£€æµ‹**:    txn.write(b"balance".to_vec(), b"100".to_vec());

```rust    

let store = Arc::new(MvccStore::new());    // é´æ„¬å§›æ©æ–¿æ´–é”›å²ƒåšœé”ã„¦å½æµœ?

    Ok(())

// äº‹åŠ¡ 1 å’Œ 2 å¹¶å‘å†™åŒä¸€é”®})?;

let mut t1 = store.begin();

let mut t2 = store.begin();// éµÑ†î”‘é™î‡î‡°æµœå¬ªå§Ÿé”›å æ©é–«ç†»çŸ¾å¯°å‹¶ç´éƒçŠ²å•¿ç»ä½¹î—…å¨´å¬¶ç´š

let result = scheduler.execute_with_mvcc_read_only(|txn| {

t1.write(b"key".to_vec(), b"value1".to_vec());    let balance = txn.read(b"balance")?

t2.write(b"key".to_vec(), b"value2".to_vec());        .ok_or("Balance not found")?;

    

// ç¬¬ä¸€ä¸ªæäº¤æˆåŠŸ    Ok(balance)

t1.commit()?;})?;

```

// ç¬¬äºŒä¸ªæäº¤å¤±è´¥ï¼ˆå†™å†™å†²çªï¼‰

assert!(t2.commit().is_err());### MVCC é—è§„â‚¬?

```

**è¹‡î‚¤åé—…æ—‚î‡ (Snapshot Isolation)**:

**åªè¯»äº‹åŠ¡ä¼˜åŒ–**:- å§£å¿é‡œæµœå¬ªå§Ÿéªå¬ªåŸŒéšîˆšå§©éƒè·ºåŸ¢é¨å‹¬æšŸé¹î†¼æ©é“?

```rust- ç’‡è¯²å½‡æ¶“å¶„ç´°çšî‚¢å•“éãƒ©æ¨†æ¿‰?

// åªè¯»äº‹åŠ¡ä½¿ç”¨å¿«é€Ÿè·¯å¾„- éæ¬å†æ¶“å¶„ç´°é—ƒè¯²î”£ç’‡è¯²å½‡

let ro_txn = store.begin_read_only();

**éæ¬å•“éèŒ¬çŠå¦«â‚¬å¨´?*:

// å¯ä»¥è¯»å–å¤šä¸ªé”®```rust

let val1 = ro_txn.read(b"key1");let store = Arc::new(MvccStore::new());

let val2 = ro_txn.read(b"key2");

// æµœå¬ªå§Ÿ 1 éœ?2 éªè·ºå½‚éæ¬æ‚“æ¶“â‚¬é–¿?

// æäº¤æ— éœ€å†²çªæ£€æµ‹ï¼Œç›´æ¥è¿”å›let mut t1 = store.begin();

let start_ts = ro_txn.commit()?;let mut t2 = store.begin();



// âŒ åªè¯»äº‹åŠ¡ä¸èƒ½å†™å…¥ï¼ˆä¼š panicï¼‰t1.write(b"key".to_vec(), b"value1".to_vec());

// ro_txn.write(...); // panic!t2.write(b"key".to_vec(), b"value2".to_vec());

```

// ç»—îƒ¿ç«´æ¶“î…å½æµœã‚†åšé”?

**ç»†ç²’åº¦å¹¶å‘æ§åˆ¶**:t1.commit()?;

- DashMap æ— é”å“ˆå¸Œè¡¨ï¼Œå‡å°‘å…¨å±€é”ç«äº‰

- æ¯é”® RwLockï¼Œå…è®¸å¤šä¸ªäº‹åŠ¡å¹¶å‘è¯»å–åŒä¸€é”®// ç»—îƒ¿ç°©æ¶“î…å½æµœã‚…ã‘ç’ãƒ¯ç´™éæ¬å•“éèŒ¬çŠé”›?

- æäº¤æ—¶æŒ‰é”®æ’åºåŠ é”ï¼Œé¿å…æ­»é”assert!(t2.commit().is_err());

- åŸå­æ—¶é—´æˆ³åˆ†é…ï¼Œæ¶ˆé™¤æ—¶é—´æˆ³ç“¶é¢ˆ```



### MVCC vs Snapshot æ€§èƒ½å¯¹æ¯”**é™î‡î‡°æµœå¬ªå§Ÿæµ¼æ¨ºå¯²**:

```rust

è¿è¡Œ MVCC åŸºå‡†æµ‹è¯•:// é™î‡î‡°æµœå¬ªå§Ÿæµ£è·¨æ•¤è¹‡î‚¦â‚¬ç†»çŸ¾å¯°?

```bashlet ro_txn = store.begin_read_only();

cargo bench --bench parallel_benchmark -- mvcc

```// é™îˆ™äº’ç’‡è¯²å½‡æ¾¶æ°«é‡œé–¿?

let val1 = ro_txn.read(b"key1");

**å…¸å‹æ€§èƒ½ç‰¹å¾**:let val2 = ro_txn.read(b"key2");

- **åªè¯»äº‹åŠ¡**: MVCC å¿«é€Ÿè·¯å¾„æ¯” Snapshot å¿« 2-5 å€

- **å¹¶å‘è¯»å–**: MVCC å…è®¸æ— é”å¹¶å‘ï¼ŒSnapshot éœ€è¦é”// é»æ„ªæ°¦éƒçŠ»æ¸¶éèŒ¬çŠå¦«â‚¬å¨´å¬¶ç´é©å­˜å¸´æ©æ–¿æ´–

- **å†™å…¥æ€§èƒ½**: æ— å†²çªæ—¶æ€§èƒ½ç›¸è¿‘ï¼ŒMVCC ç•¥æœ‰å¼€é”€ï¼ˆç‰ˆæœ¬ç®¡ç†ï¼‰let start_ts = ro_txn.commit()?;

- **å†²çªåœºæ™¯**: MVCC åœ¨æäº¤æ—¶æ£€æµ‹ï¼ŒSnapshot åœ¨é”è·å–æ—¶é˜»å¡

// é‰‚?é™î‡î‡°æµœå¬ªå§Ÿæ¶“å¶ˆå…˜éæ¬å†é”›å œç´° panicé”›?

---// ro_txn.write(...); // panic!

```

## æœªæ¥ä¼˜åŒ–

**ç¼å—™çŸ‘æ´ï¹€è‹Ÿé™æˆå¸¶é’?*:

### MVCC åƒåœ¾å›æ”¶ (v0.6.0) ğŸ—‘ï¸- DashMap éƒçŠ»æ”£éå ç¬‡ç›îŸ’ç´é‘å¿“çš¯éã„¥çœ¬é–¿ä½ºçµæµœ?

- å§£å¿›æ•­ RwLocké”›å±½å‘ç’ç¨¿î˜¿æ¶“îƒç°¨é”â€³è‹Ÿé™æˆ£î‡°é™æ §æ‚“æ¶“â‚¬é–¿?

#### ä¸ºä»€ä¹ˆéœ€è¦ GCï¼Ÿ- é»æ„ªæ°¦éƒèˆµå¯œé–¿î†½å¸“æ´å¿“å§é–¿ä¾Šç´é–¬å®å¤å§å©šæ”£

- é˜ç†·ç“™éƒå •æ£¿é´å†²åé–°å¶ç´å¨‘å ¥æ«éƒå •æ£¿é´å´‡æ‘±æ£°?

MVCC ä¸ºæ¯ä¸ªé”®ç»´æŠ¤å¤šä¸ªç‰ˆæœ¬ï¼Œéšç€äº‹åŠ¡çš„æ‰§è¡Œï¼Œç‰ˆæœ¬æ•°ä¼šä¸æ–­å¢é•¿ã€‚å¦‚æœä¸æ¸…ç†æ—§ç‰ˆæœ¬ä¼šï¼š

- **å†…å­˜å ç”¨**æŒç»­å¢åŠ ### MVCC vs Snapshot é¬Ñ†å…˜ç€µè§„ç˜®

- **æŸ¥æ‰¾æ€§èƒ½**ä¸‹é™ï¼ˆç‰ˆæœ¬é“¾è¿‡é•¿ï¼‰

- **å­˜å‚¨å¼€é”€**å¤±æ§æ©æ„¯î”‘ MVCC é©å“„å™¯å¨´å¬­ç˜¯:

```bash

#### GC é…ç½®cargo bench --bench parallel_benchmark -- mvcc

```

```rust

use vm_runtime::{MvccStore, GcConfig};**éç¨¿ç€·é¬Ñ†å…˜é—ç‘°ç·›**:

- **é™î‡î‡°æµœå¬ªå§Ÿ**: MVCC è¹‡î‚¦â‚¬ç†»çŸ¾å¯°å‹¬ç˜® Snapshot è¹‡?2-5 éŠ?

let config = GcConfig {- **éªè·ºå½‚ç’‡è¯²å½‡**: MVCC éä½½î†éƒçŠ»æ”£éªè·ºå½‚é”›å­²napshot é—‡â‚¬ç‘•ä¾€æ”£

    max_versions_per_key: 10,      // æ¯ä¸ªé”®æœ€å¤šä¿ç•™ 10 ä¸ªç‰ˆæœ¬- **éæ¬å†é¬Ñ†å…˜**: éƒçŠ²å•¿ç»ä½¹æ¤‚é¬Ñ†å…˜é©æ­Œç¹é”›å­§VCC é£ãƒ¦æ¹å¯®â‚¬é–¿â‚¬é”›å ¢å¢—éˆî„‚î…¸éå—­ç´š

    enable_time_based_gc: false,   // åŸºäºæ—¶é—´çš„ GCï¼ˆæœªæ¥åŠŸèƒ½ï¼‰- **éèŒ¬çŠé¦çƒ˜æ«™**: MVCC é¦ã„¦å½æµœã‚†æ¤‚å¦«â‚¬å¨´å¬¶ç´Snapshot é¦ã„©æ”£é‘¾å³°å½‡éƒå •æ¨†æ¿‰?

    version_ttl_secs: 3600,        // ç‰ˆæœ¬è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰

};---



let store = MvccStore::new_with_config(config);## éˆî…æ½µæµ¼æ¨ºå¯²

```

### MVCC é¨å†¨æº‡é¥ç‚´æ•¹ (v0.6.0) é¦ƒæ£é””?

#### æ‰‹åŠ¨è§¦å‘ GC

#### æ¶“è½°ç²ˆæ¶”å ¥æ¸¶ç‘•?GCé”›?

```rust

// æ‰§è¡Œä¸€æ¬¡ GCMVCC æ¶“çƒ˜ç˜¡æ¶“îˆæ•­ç¼å­˜å§¢æ¾¶æ°«é‡œé—å Ÿæ¹°é”›å²„æ®¢é«â‚¬æµœå¬ªå§Ÿé¨å‹¬å¢½ç›å²‹ç´é—å Ÿæ¹°éé¢ç´°æ¶“å¶†æŸ‡æ¾§ç‚ºæš±éŠ†å‚šî›§é‹æ»€ç¬‰å¨“å‘¯æ‚ŠéƒÑ…å¢—éˆî„Šç´°

let cleaned_count = store.gc()?;- **éå‘­ç“¨é—çŠµæ•¤**é¸ä½ºç”»æ¾§ç‚²å§

println!("æ¸…ç†äº† {} ä¸ªæ—§ç‰ˆæœ¬", cleaned_count);- **éŒãƒ¦å£˜é¬Ñ†å…˜**æ¶“å¬®æª·é”›å ¢å¢—éˆî„„æ‘¼æ©å›¬æš±é”›?

- **ç€›æ¨ºåå¯®â‚¬é–¿â‚¬**æ¾¶è¾¨å¸¶

// è·å– GC ç»Ÿè®¡

let stats = store.get_gc_stats();#### GC é–°å¶‡ç–†

println!("GC æ‰§è¡Œæ¬¡æ•°: {}", stats.gc_count);

println!("æ€»æ¸…ç†ç‰ˆæœ¬æ•°: {}", stats.versions_cleaned);```rust

println!("æ¸…ç†çš„é”®æ•°: {}", stats.keys_cleaned);use vm_runtime::{MvccStore, GcConfig};

println!("æœ€å GC æ—¶é—´æˆ³: {}", stats.last_gc_ts);

let config = GcConfig {

// ç›‘æ§å­˜å‚¨çŠ¶æ€    max_versions_per_key: 10,      // å§£å¿é‡œé–¿î†½æ¸¶æ¾¶æ°«ç¹šé£?10 æ¶“î†å¢—éˆ?

println!("å½“å‰æ€»ç‰ˆæœ¬æ•°: {}", store.total_versions());    enable_time_based_gc: false,   // é©è½°ç°¬éƒå •æ£¿é¨?GCé”›å Ÿæ¹­é‰ãƒ¥å§›é‘³æ–¤ç´š

println!("å½“å‰é”®æ•°é‡: {}", store.total_keys());    version_ttl_secs: 3600,        // é—å Ÿæ¹°æ©å›¨æ¹¡éƒå •æ£¿é”›å ¢î—é”›?

println!("æœ€å°æ´»è·ƒäº‹åŠ¡æ—¶é—´æˆ³: {:?}", store.get_min_active_ts());};

```

let store = MvccStore::new_with_config(config);

#### GC æ¸…ç†ç­–ç•¥```



**ä¿ç•™è§„åˆ™**ï¼ˆä¼˜å…ˆçº§ä»é«˜åˆ°ä½ï¼‰:#### éµå¬ªå§©ç‘™ï¹€å½‚ GC

1. **æœ€æ–°ç‰ˆæœ¬**: æ¯ä¸ªé”®çš„æœ€æ–°ç‰ˆæœ¬æ°¸è¿œä¿ç•™

2. **æ´»è·ƒäº‹åŠ¡å¯è§ç‰ˆæœ¬**: æ‰€æœ‰æ´»è·ƒäº‹åŠ¡å¯èƒ½è¯»åˆ°çš„ç‰ˆæœ¬å¿…é¡»ä¿ç•™```rust

3. **ç‰ˆæœ¬æ•°é‡é™åˆ¶**: æ ¹æ® `max_versions_per_key` æ¸…ç†è¶…é‡æ—§ç‰ˆæœ¬// éµÑ†î”‘æ¶“â‚¬å¨†?GC

let cleaned_count = store.gc()?;

**æ¸…ç†æµç¨‹**:println!("å¨“å‘¯æ‚Šæµœ?{} æ¶“î…æ£«é—å Ÿæ¹°", cleaned_count);

```

å¯¹æ¯ä¸ªé”®çš„ç‰ˆæœ¬é“¾:// é‘¾å³°å½‡ GC ç¼ç†»î…¸

  1. æ‰¾åˆ°æœ€å°æ´»è·ƒäº‹åŠ¡ start_ts (æ°´ä½çº¿)let stats = store.get_gc_stats();

  2. ä¿ç•™ ts <= start_ts çš„ç¬¬ä¸€ä¸ªç‰ˆæœ¬åŠä¹‹åçš„æ‰€æœ‰ç‰ˆæœ¬println!("GC éµÑ†î”‘å¨†â„ƒæšŸ: {}", stats.gc_count);

  3. åœ¨æ­¤åŸºç¡€ä¸Šï¼Œæ ¹æ® max_versions_per_key é™åˆ¶è¿›ä¸€æ­¥æ¸…ç†println!("é¬ç»˜ç«»éå—™å¢—éˆî„æšŸ: {}", stats.versions_cleaned);

  4. æœ€æ–°ç‰ˆæœ¬æ— æ¡ä»¶ä¿ç•™println!("å¨“å‘¯æ‚Šé¨å‹¯æ•­é? {}", stats.keys_cleaned);

```println!("éˆâ‚¬éš?GC éƒå •æ£¿é´? {}", stats.last_gc_ts);



**ç¤ºä¾‹**:// é©æˆå¸¶ç€›æ¨ºåé˜èˆµâ‚¬?

```rustprintln!("è¤°æ’³å¢ é¬è¤å¢—éˆî„æšŸ: {}", store.total_versions());

let store = MvccStore::new_with_config(GcConfig {println!("è¤°æ’³å¢ é–¿î†½æšŸé–²? {}", store.total_keys());

    max_versions_per_key: 3,println!("éˆâ‚¬çå¿”æ¤¿ç’ºå†§ç°¨é”â„ƒæ¤‚é—‚å­˜åŸ‘: {:?}", store.get_min_active_ts());

    ..Default::default()```

});

#### GC å¨“å‘¯æ‚Šç»›æ «æš

// å†™å…¥ 5 ä¸ªç‰ˆæœ¬: ts=1,2,3,4,5

for i in 1..=5 {**æ·‡æ¿ˆæš€ç‘™å‹«å¯**é”›å œç´­éå ¢éª‡æµ åº¨ç®é’é¢ç¶†é”›?

    let mut txn = store.begin();1. **éˆâ‚¬é‚æ‰®å¢—éˆ?*: å§£å¿é‡œé–¿î†¾æ®‘éˆâ‚¬é‚æ‰®å¢—éˆî„æ¡ˆæ©æ»€ç¹šé£?

    txn.write(b"key".to_vec(), format!("v{}", i).into_bytes());2. **å¨²æ˜ç©¬æµœå¬ªå§Ÿé™îˆî†é—å Ÿæ¹°**: éµâ‚¬éˆå¤‹æ¤¿ç’ºå†§ç°¨é”â€³å½²é‘³å€Ÿî‡°é’æ‰®æ®‘é—å Ÿæ¹°è¹‡å‘´ã€æ·‡æ¿ˆæš€

    txn.commit()?;3. **é—å Ÿæ¹°éä¼´å™ºé—„æ„¬åŸ—**: éè§„åµ `max_versions_per_key` å¨“å‘¯æ‚Šç“’å‘´å™ºéƒÑ…å¢—éˆ?

}

**å¨“å‘¯æ‚Šå¨´ä½ºâ–¼**:

// å¼€å¯ä¸€ä¸ªé•¿äº‹åŠ¡ï¼ˆstart_ts=6ï¼Œèƒ½çœ‹åˆ° ts<=6 çš„ç‰ˆæœ¬ï¼Œå³æ‰€æœ‰ç‰ˆæœ¬ï¼‰```

let long_txn = store.begin();ç€µè§„ç˜¡æ¶“îˆæ•­é¨å‹­å¢—éˆî„„æ‘¼:

  1. éµæƒ§åŸŒéˆâ‚¬çå¿”æ¤¿ç’ºå†§ç°¨é”?start_ts (å§˜ç¿ ç¶…ç»¾?

// å†å†™å…¥ v6, v7  2. æ·‡æ¿ˆæš€ ts <= start_ts é¨å‹­îƒ‡æ¶“â‚¬æ¶“î†å¢—éˆî„€å¼·æ¶”å¬ªæ‚—é¨å‹¬å¢éˆå¤Œå¢—éˆ?

for i in 6..=7 {  3. é¦ã„¦î„é©è™¹î”…æ¶“å©ç´éè§„åµ max_versions_per_key é—„æ„¬åŸ—æ©æ¶—ç«´å§ãƒ¦ç«»é?

    let mut txn = store.begin();  4. éˆâ‚¬é‚æ‰®å¢—éˆî„æ£¤é‰â€²æ¬¢æ·‡æ¿ˆæš€

    txn.write(b"key".to_vec(), format!("v{}", i).into_bytes());```

    txn.commit()?;

}**ç»€è½°ç·¥**:

```rust

// æ­¤æ—¶æœ‰ 7 ä¸ªç‰ˆæœ¬ï¼Œæœ€å°æ´»è·ƒ ts=6let store = MvccStore::new_with_config(GcConfig {

store.gc()?;    max_versions_per_key: 3,

    ..Default::default()

// GC å:});

// - ä¿ç•™ ts=1 (long_txn çš„æ°´ä½çº¿å†…ç¬¬ä¸€ä¸ªå¯è§ç‰ˆæœ¬)

// - ä¿ç•™ ts=2,3,4,5,6,7 (éƒ½ >= min_active_ts)// éæ¬å† 5 æ¶“î†å¢—éˆ? ts=1,2,3,4,5

// - æ‰€æœ‰ç‰ˆæœ¬éƒ½è¢«ä¿ç•™ï¼Œå› ä¸º long_txn ä»æ´»è·ƒfor i in 1..=5 {

    let mut txn = store.begin();

drop(long_txn); // ç»“æŸé•¿äº‹åŠ¡    txn.write(b"key".to_vec(), format!("v{}", i).into_bytes());

    txn.commit()?;

store.gc()?;}



// GC å:// å¯®â‚¬éšîˆ™ç«´æ¶“îˆæš±æµœå¬ªå§Ÿé”›å°tart_ts=6é”›å²ƒå…˜éªå¬ªåŸŒ ts<=6 é¨å‹­å¢—éˆî„Šç´é—è™«å¢éˆå¤Œå¢—éˆî„Šç´š

// - æ²¡æœ‰æ´»è·ƒäº‹åŠ¡ï¼Œæ ¹æ® max_versions_per_key=3let long_txn = store.begin();

// - ä¿ç•™æœ€æ–°çš„ 3 ä¸ªç‰ˆæœ¬: ts=5,6,7

// - æ¸…ç† ts=1,2,3,4// éå¶…å•“é?v6, v7

```for i in 6..=7 {

    let mut txn = store.begin();

#### æ´»è·ƒäº‹åŠ¡è·Ÿè¸ª    txn.write(b"key".to_vec(), format!("v{}", i).into_bytes());

    txn.commit()?;

MVCC è‡ªåŠ¨è·Ÿè¸ªæ´»è·ƒäº‹åŠ¡:}

```rust

// å¼€å§‹äº‹åŠ¡æ—¶è‡ªåŠ¨æ³¨å†Œ// å§ã‚†æ¤‚éˆ?7 æ¶“î†å¢—éˆî„Šç´éˆâ‚¬çå¿”æ¤¿ç’º?ts=6

let txn1 = store.begin();store.gc()?;

let txn2 = store.begin_read_only();

// GC éš?

// æŸ¥è¯¢æ´»è·ƒäº‹åŠ¡æ°´ä½çº¿// - æ·‡æ¿ˆæš€ ts=1 (long_txn é¨å‹¬æŒ‰æµ£å¶‡åšéå‘¯îƒ‡æ¶“â‚¬æ¶“î„å½²ç‘™ä½ºå¢—éˆ?

let min_ts = store.get_min_active_ts();// - æ·‡æ¿ˆæš€ ts=2,3,4,5,6,7 (é–®?>= min_active_ts)

println!("æœ€å°æ´»è·ƒ ts: {:?}", min_ts);// - éµâ‚¬éˆå¤Œå¢—éˆî„„å…˜çšî‚¡ç¹šé£æ¬™ç´é¥çŠ±è´Ÿ long_txn æµ å¶†æ¤¿ç’º?



// äº‹åŠ¡ç»“æŸæ—¶è‡ªåŠ¨æ³¨é”€ï¼ˆdrop traitï¼‰drop(long_txn); // ç¼æ’´æ½«é—€å¤¸ç°¨é”?

drop(txn1);

drop(txn2);store.gc()?;



// ç°åœ¨æ²¡æœ‰æ´»è·ƒäº‹åŠ¡// GC éš?

assert_eq!(store.get_min_active_ts(), None);// - å¨Œâ„ƒæ¹å¨²æ˜ç©¬æµœå¬ªå§Ÿé”›å±¾ç‰´é¹?max_versions_per_key=3

```// - æ·‡æ¿ˆæš€éˆâ‚¬é‚æ‰®æ®‘ 3 æ¶“î†å¢—éˆ? ts=5,6,7

// - å¨“å‘¯æ‚Š ts=1,2,3,4

#### GC æœ€ä½³å®è·µ```



**1. å®šæœŸè§¦å‘ GC**:#### å¨²æ˜ç©¬æµœå¬ªå§Ÿç’ºç†»é‡œ

```rust

// ç®€å•ç­–ç•¥ï¼šæ¯ N ä¸ªäº‹åŠ¡è§¦å‘ä¸€æ¬¡MVCC é‘·î„å§©ç’ºç†»é‡œå¨²æ˜ç©¬æµœå¬ªå§Ÿ:

let mut tx_count = 0;```rust

loop {// å¯®â‚¬æ¿®å¬©ç°¨é”â„ƒæ¤‚é‘·î„å§©å¨‰ã„¥å”½

    // æ‰§è¡Œäº‹åŠ¡...let txn1 = store.begin();

    tx_count += 1;let txn2 = store.begin_read_only();

    

    if tx_count % 100 == 0 {// éŒãƒ¨î‡—å¨²æ˜ç©¬æµœå¬ªå§Ÿå§˜ç¿ ç¶…ç»¾?

        store.gc()?;let min_ts = store.get_min_active_ts();

    }println!("éˆâ‚¬çå¿”æ¤¿ç’º?ts: {:?}", min_ts);

}

```// æµœå¬ªå§Ÿç¼æ’´æ½«éƒæƒ°åšœé”ã„¦æ•é–¿â‚¬é”›åœ–rop traité”›?

drop(txn1);

**2. åŸºäºç‰ˆæœ¬æ•°è§¦å‘**:drop(txn2);

```rust

// ç‰ˆæœ¬æ•°è¶…è¿‡é˜ˆå€¼æ—¶è§¦å‘// éœæ¿æ¹ªå¨Œâ„ƒæ¹å¨²æ˜ç©¬æµœå¬ªå§Ÿ

if store.total_versions() > 10000 {assert_eq!(store.get_min_active_ts(), None);

    println!("ç‰ˆæœ¬æ•°è¿‡å¤šï¼Œè§¦å‘ GC");```

    let cleaned = store.gc()?;

    println!("æ¸…ç†äº† {} ä¸ªç‰ˆæœ¬", cleaned);#### GC éˆâ‚¬æµ£å†²ç–„ç’º?

}

```**1. ç€¹æ°­æ¹¡ç‘™ï¹€å½‚ GC**:

```rust

**3. ç›‘æ§ GC æ•ˆæœ**:// ç» â‚¬é—æ› ç“¥é£ãƒ¯ç´°å§£?N æ¶“îƒç°¨é”Â¤Ğ•é™æˆœç«´å¨†?

```rustlet mut tx_count = 0;

let before_versions = store.total_versions();loop {

let cleaned = store.gc()?;    // éµÑ†î”‘æµœå¬ªå§Ÿ...

let after_versions = store.total_versions();    tx_count += 1;

    

println!("GC å‰: {} ç‰ˆæœ¬", before_versions);    if tx_count % 100 == 0 {

println!("æ¸…ç†: {} ç‰ˆæœ¬", cleaned);        store.gc()?;

println!("GC å: {} ç‰ˆæœ¬", after_versions);    }

println!("å‹ç¼©ç‡: {:.2}%", }

    cleaned as f64 / before_versions as f64 * 100.0);```

```

**2. é©è½°ç°¬é—å Ÿæ¹°éæ‹ŒĞ•é™?*:

**4. é¿å…åœ¨äº‹åŠ¡ä¸­è§¦å‘ GC**:```rust

```rust// é—å Ÿæ¹°éæ‹Œç§´æ©å›¬æ§‡éŠå…¼æ¤‚ç‘™ï¹€å½‚

// âŒ ä¸å¥½ - å¯èƒ½æ¸…ç†å½“å‰äº‹åŠ¡éœ€è¦çš„ç‰ˆæœ¬if store.total_versions() > 10000 {

let txn = store.begin();    println!("é—å Ÿæ¹°éæ‹Œç¹ƒæ¾¶æ°¾ç´ç‘™ï¹€å½‚ GC");

store.gc()?; // å±é™©ï¼    let cleaned = store.gc()?;

txn.read(b"key");    println!("å¨“å‘¯æ‚Šæµœ?{} æ¶“î†å¢—éˆ?, cleaned);

}

// âœ… å¥½ - åœ¨äº‹åŠ¡ä¹‹é—´è§¦å‘```

drop(txn);

store.gc()?;**3. é©æˆå¸¶ GC éå Ÿç‰**:

let txn2 = store.begin();```rust

```let before_versions = store.total_versions();

let cleaned = store.gc()?;

#### GC æ€§èƒ½å½±å“let after_versions = store.total_versions();



è¿è¡Œ GC åŸºå‡†æµ‹è¯•:println!("GC é“? {} é—å Ÿæ¹°", before_versions);

```bashprintln!("å¨“å‘¯æ‚Š: {} é—å Ÿæ¹°", cleaned);

cargo bench --bench parallel_benchmark -- mvcc_gcprintln!("GC éš? {} é—å Ÿæ¹°", after_versions);

```println!("é˜å¬¬ç¼‰éœ? {:.2}%", 

    cleaned as f64 / before_versions as f64 * 100.0);

**å…¸å‹æ€§èƒ½ç‰¹å¾**:```

- **GC ååé‡**: æ¯æ¬¡ GC å¯æ¸…ç†æ•°åƒåˆ°æ•°ä¸‡ä¸ªç‰ˆæœ¬ï¼ˆæ¯«ç§’çº§ï¼‰

- **è¯»å–å½±å“**: GC ä½¿ç”¨å†™é”ï¼Œä¸é˜»å¡è¯»æ“ä½œï¼ˆå¹¶å‘è¯»å–ä¸å—å½±å“ï¼‰**4. é–¬å®å¤é¦ã„¤ç°¨é”â€²è…‘ç‘™ï¹€å½‚ GC**:

- **å†™å…¥å½±å“**: GC æœŸé—´æ–°å†™å…¥éœ€è¦ç­‰å¾…ï¼ˆä½† GC é€šå¸¸å¾ˆå¿«ï¼‰```rust

- **æ´»è·ƒäº‹åŠ¡å½±å“**: æ´»è·ƒäº‹åŠ¡è¶Šå¤šï¼Œå¯æ¸…ç†çš„ç‰ˆæœ¬è¶Šå°‘// é‰‚?æ¶“å¶…ã‚½ - é™îˆå…˜å¨“å‘¯æ‚Šè¤°æ’³å¢ æµœå¬ªå§Ÿé—‡â‚¬ç‘•ä½ºæ®‘é—å Ÿæ¹°

let txn = store.begin();

---store.gc()?; // é—éæ«“é”›?

txn.read(b"key");

## MVCC è‡ªåŠ¨åƒåœ¾å›æ”¶ (v0.7.0 ğŸ‰)

// é‰?æ¿‚?- é¦ã„¤ç°¨é”â€²ç®£é—‚ç£‹Ğ•é™?

### åŠŸèƒ½æ¦‚è¿°drop(txn);

store.gc()?;

è‡ªåŠ¨ GC åœ¨åå°çº¿ç¨‹å‘¨æœŸæ€§æ¸…ç†è¿‡æœŸç‰ˆæœ¬ï¼Œæ— éœ€æ‰‹åŠ¨è°ƒç”¨ `gc()` æ–¹æ³•ã€‚let txn2 = store.begin();

```

### é…ç½®

#### GC é¬Ñ†å…˜è¤°åæ·

```rust

use vm_runtime::{MvccStore, GcConfig, AutoGcConfig};æ©æ„¯î”‘ GC é©å“„å™¯å¨´å¬­ç˜¯:

use std::sync::Arc;```bash

cargo bench --bench parallel_benchmark -- mvcc_gc

let config = GcConfig {```

    max_versions_per_key: 10,

    enable_time_based_gc: false,**éç¨¿ç€·é¬Ñ†å…˜é—ç‘°ç·›**:

    version_ttl_secs: 3600,- **GC éšç‚²æ‚™é–²?*: å§£å¿”î‚¼ GC é™îˆ›ç«»éå—˜æšŸé—å†¨åŸŒéé¢ç«¾æ¶“î†å¢—éˆî„Šç´™å§£î‚¤î—ç»¾Ñç´š

    auto_gc: Some(AutoGcConfig {- **ç’‡è¯²å½‡è¤°åæ·**: GC æµ£è·¨æ•¤éæ¬“æ”£é”›å±¼ç¬‰é—ƒè¯²î”£ç’‡ç»˜æ·æµ£æ»ç´™éªè·ºå½‚ç’‡è¯²å½‡æ¶“å¶…å½ˆè¤°åæ·é”›?

        interval_secs: 60,            // æ¯ 60 ç§’æ‰§è¡Œä¸€æ¬¡- **éæ¬å†è¤°åæ·**: GC éˆç†¼æ£¿é‚æ¿å•“éãƒ©æ¸¶ç‘•ä½ºç“‘å¯°å’ƒç´™æµ£?GC é–«æ°¬çˆ¶å¯°å æ©é”›?

        version_threshold: 1000,      // ç‰ˆæœ¬æ•° â‰¥ 1000 æ—¶è§¦å‘- **å¨²æ˜ç©¬æµœå¬ªå§Ÿè¤°åæ·**: å¨²æ˜ç©¬æµœå¬ªå§Ÿç“’å©‚î˜¿é”›å±½å½²å¨“å‘¯æ‚Šé¨å‹­å¢—éˆî„ƒç§ºç?

        run_on_start: false,          // å¯åŠ¨æ—¶ä¸ç«‹å³æ‰§è¡Œ

    }),## MVCC é‘·î„å§©é¨å†¨æº‡é¥ç‚´æ•¹ (v0.7.0 é¦ƒå¸€)

};

### é”ç†»å…˜å§’å‚å ª

let store = Arc::new(MvccStore::new_with_config(config));

// è‡ªåŠ¨ GC åå°çº¿ç¨‹å·²è‡ªåŠ¨å¯åŠ¨é‘·î„å§© GC é¦ã„¥æ‚—é™æ‰®åšç»‹å¬ªæ‡†éˆç†¸â‚¬Ñ„ç«»éå—šç¹ƒéˆç†ºå¢—éˆî„Šç´éƒçŠ»æ¸¶éµå¬ªå§©ç’‹å†ªæ•¤ `gc()` é‚è§„ç¡¶éŠ†?

```

### é–°å¶‡ç–†

### è§¦å‘ç­–ç•¥

```rust

1. **å‘¨æœŸæ€§è§¦å‘**: æ¯éš” `interval_secs` ç§’æ‰§è¡Œä¸€æ¬¡ GCuse vm_runtime::{MvccStore, GcConfig, AutoGcConfig};

2. **é˜ˆå€¼è§¦å‘**: å½“ `total_versions() >= version_threshold` æ—¶ç«‹å³æ‰§è¡Œuse std::sync::Arc;

   - è®¾ç½® `version_threshold = 0` ç¦ç”¨é˜ˆå€¼æ£€æŸ¥ï¼Œä»…ä½¿ç”¨å‘¨æœŸè§¦å‘

3. **å¯åŠ¨è§¦å‘**: `run_on_start = true` æ—¶ç«‹å³æ‰§è¡Œä¸€æ¬¡let config = GcConfig {

    max_versions_per_key: 10,

### æ‰‹åŠ¨æ§åˆ¶    enable_time_based_gc: false,

    version_ttl_secs: 3600,

```rust    auto_gc: Some(AutoGcConfig {

// åœæ­¢è‡ªåŠ¨ GC        interval_secs: 60,            // å§£?60 ç»‰æ“å¢½ç›å±¼ç«´å¨†?

store.stop_auto_gc();        version_threshold: 1000,      // é—å Ÿæ¹°é?éˆ®?1000 éƒæƒ°Ğ•é™?

        run_on_start: false,          // éšîˆšå§©éƒæœµç¬‰ç»”å¬ªåµ†éµÑ†î”‘

// é‡æ–°å¯åŠ¨    }),

store.start_auto_gc();};



// æ£€æŸ¥è¿è¡ŒçŠ¶æ€let store = Arc::new(MvccStore::new_with_config(config));

if store.is_auto_gc_running() {// é‘·î„å§© GC éšåº¡å½´ç»¾è·¨â–¼å®¸èŒ¶åšœé”ã„¥æƒé”?

    println!("è‡ªåŠ¨ GC æ­£åœ¨è¿è¡Œ");```

}

### ç‘™ï¹€å½‚ç»›æ «æš

// åŠ¨æ€æ›´æ–°é…ç½®

store.update_auto_gc_config(Some(AutoGcConfig {1. **é›ã„¦æ¹¡é¬Ñ†Ğ•é™?*: å§£å¿›æ®§ `interval_secs` ç»‰æ“å¢½ç›å±¼ç«´å¨†?GC

    interval_secs: 30,       // æ”¹ä¸º 30 ç§’2. **é—ƒå â‚¬è‰°Ğ•é™?*: è¤°?`total_versions() >= version_threshold` éƒå‰ç›é—è™«å¢½ç›?

    version_threshold: 500,  // é™ä½é˜ˆå€¼   - ç’å‰§ç–† `version_threshold = 0` ç»‚ä½ºæ•¤é—ƒå â‚¬å…¼î—…éŒãƒ¯ç´æµ å‘¬å¨‡é¢ã„¥æ‡†éˆç†»Ğ•é™?

    run_on_start: false,3. **éšîˆšå§©ç‘™ï¹€å½‚**: `run_on_start = true` éƒå‰ç›é—è™«å¢½ç›å±¼ç«´å¨†?

}));

### éµå¬ªå§©éºÑƒåŸ—

// ç¦ç”¨è‡ªåŠ¨ GC

store.update_auto_gc_config(None);```rust

```// é‹æ»„î„›é‘·î„å§© GC

store.stop_auto_gc();

### çº¿ç¨‹å®‰å…¨

// é–²å¶†æŸŠéšîˆšå§©

- è‡ªåŠ¨ GC ä¸äº‹åŠ¡å¹¶å‘æ‰§è¡Œæ˜¯å®‰å…¨çš„ï¼ˆè¯»å†™é”ä¿æŠ¤ï¼‰store.start_auto_gc();

- GC çº¿ç¨‹ä½¿ç”¨å¯ä¸­æ–­ä¼‘çœ (100ms ç²’åº¦)ï¼Œå¿«é€Ÿå“åº”åœæ­¢ä¿¡å·

- Drop æ—¶è‡ªåŠ¨åœæ­¢ GC çº¿ç¨‹å¹¶ç­‰å¾…é€€å‡º(æœ€å¤š 2 ç§’)// å¦«â‚¬éŒãƒ¨ç¹ç›å²€å§¸é¬?

if store.is_auto_gc_running() {

### æ€§èƒ½å½±å“    println!("é‘·î„å§© GC å§ï½…æ¹ªæ©æ„¯î”‘");

}

è¿è¡ŒåŸºå‡†æµ‹è¯•å¯¹æ¯”è‡ªåŠ¨ GC çš„å¼€é”€:

```bash// é”ã„¦â‚¬ä½¹æ´¿é‚ä¼´å¤ç¼ƒ?

cargo bench --bench parallel_benchmark -- auto_gcstore.update_auto_gc_config(Some(AutoGcConfig {

```    interval_secs: 30,       // é€é€›è´Ÿ 30 ç»‰?

    version_threshold: 500,  // é—„å¶„ç¶†é—ƒå â‚¬?

**å…¸å‹ç»“æœ**:    run_on_start: false,

- **å†™å…¥å¼€é”€**: < 5%ï¼ˆè‡ªåŠ¨ GC åœ¨åå°è¿è¡Œï¼Œä¸é˜»å¡å†™æ“ä½œï¼‰}));

- **è¯»å–å¼€é”€**: æ— æ˜æ˜¾å½±å“ï¼ˆGC ä½¿ç”¨å†™é”ï¼Œä¸é˜»å¡å¹¶å‘è¯»ï¼‰

- **CPU å ç”¨**: ä¼‘çœ æ—¶å‡ ä¹ä¸º 0ï¼ŒGC æ‰§è¡Œæ—¶çŸ­æš‚å³°å€¼// ç»‚ä½ºæ•¤é‘·î„å§© GC

store.update_auto_gc_config(None);

### æœ€ä½³å®è·µ```



1. **ç”Ÿäº§ç¯å¢ƒ**: å¯ç”¨è‡ªåŠ¨ GCï¼Œè®¾ç½®åˆç†çš„ `interval_secs` (30-60s)### ç»¾è·¨â–¼ç€¹å¤Šå

2. **é«˜å†™å…¥åœºæ™¯**: é™ä½ `version_threshold` (500-1000) ä»¥æ›´é¢‘ç¹æ¸…ç†

3. **ä½è´Ÿè½½åœºæ™¯**: æé«˜ `interval_secs` (120-300s) ä»¥å‡å°‘å¼€é”€- é‘·î„å§© GC æ¶“åºç°¨é”â€³è‹Ÿé™æˆå¢½ç›å±¾æ§¸ç€¹å¤Šåé¨å‹¶ç´™ç’‡è¯²å•“é–¿ä½·ç¹šé¶ã‚ç´š

4. **æµ‹è¯•ç¯å¢ƒ**: å¯ç¦ç”¨è‡ªåŠ¨ GC (`auto_gc: None`) ä¾¿äºè°ƒè¯•- GC ç»¾è·¨â–¼æµ£è·¨æ•¤é™îˆ™è…‘é‚î…ç´¤éª?(100ms ç»®æ‘å®³)é”›å±½æ©é–«ç†·æ·æ´æ–¿ä» å§î­ä¿Šé™?

- Drop éƒæƒ°åšœé”ã„¥ä» å§?GC ç»¾è·¨â–¼éªå‰ç“‘å¯°å‘´â‚¬â‚¬é‘?(éˆâ‚¬æ¾¶?2 ç»‰?

---

### é¬Ñ†å…˜è¤°åæ·

## è·¯çº¿å›¾

æ©æ„¯î”‘é©å“„å™¯å¨´å¬­ç˜¯ç€µè§„ç˜®é‘·î„å§© GC é¨å‹«ç´‘é–¿â‚¬:

### çŸ­æœŸ (v0.8.0)```bash

- [ ] MVCC å‹åŠ›æµ‹è¯•ä¸è°ƒä¼˜cargo bench --bench parallel_benchmark -- auto_gc

- [ ] äº¤æ˜“ä¼˜å…ˆçº§è°ƒåº¦ç­–ç•¥å¼ºåŒ–```

- [ ] è‡ªåŠ¨ GC è‡ªé€‚åº”ç­–ç•¥ï¼ˆæ ¹æ®è´Ÿè½½åŠ¨æ€è°ƒæ•´é—´éš”ï¼‰

**éç¨¿ç€·ç¼æ’´ç‰**:

### ä¸­æœŸ (v0.9.0)- **éæ¬å†å¯®â‚¬é–¿â‚¬**: < 5%é”›å £åšœé”?GC é¦ã„¥æ‚—é™æ‹Œç¹ç›å²‹ç´æ¶“å¶‰æ¨†æ¿‰ç‚²å•“é¿å¶„ç¶”é”›?

- [ ] ä¹è§‚å¹¶å‘æ§åˆ¶ï¼ˆOCCï¼‰é›†æˆ- **ç’‡è¯²å½‡å¯®â‚¬é–¿â‚¬**: éƒçŠ³æ§‘é„æƒ§å¥–éå¶ç´™GC æµ£è·¨æ•¤éæ¬“æ”£é”›å±¼ç¬‰é—ƒè¯²î”£éªè·ºå½‚ç’‡ä¼™ç´š

- [ ] è·¨åˆ†ç‰‡/åˆ†åŒºçš„å¹¶è¡Œè°ƒåº¦æ¢ç´¢- **CPU é—çŠµæ•¤**: æµ¼æˆ æ¹¢éƒè·ºåš‘æ¶”åºè´Ÿ 0é”›å­C éµÑ†î”‘éƒå‰ç…­é†å‚šå˜²éŠ?

- [ ] MVCC ä¸ Snapshot è‡ªåŠ¨é€‰æ‹©ç­–ç•¥

### éˆâ‚¬æµ£å†²ç–„ç’º?

### é•¿æœŸ (v1.0.0)

- [ ] åˆ†å¸ƒå¼å¹¶è¡Œæ‰§è¡Œ1. **é¢ç†¶éª‡éœîˆšî•¨**: éšîˆœæ•¤é‘·î„å§© GCé”›å²ƒî†•ç¼ƒî†¼æ‚éå—™æ®‘ `interval_secs` (30-60s)

- [ ] GPU åŠ é€Ÿå†²çªæ£€æµ‹2. **æ¥‚æ¨ºå•“éãƒ¥æº€é…?*: é—„å¶„ç¶† `version_threshold` (500-1000) æµ ãƒ¦æ´¿æ£°æˆ ç®’å¨“å‘¯æ‚Š

- [ ] æœºå™¨å­¦ä¹ ä¼˜åŒ–è°ƒåº¦3. **æµ£åº¤ç¤‹æè—‰æº€é…?*: é»æ„°ç® `interval_secs` (120-300s) æµ ãƒ¥å™ºçæˆç´‘é–¿â‚¬

4. **å¨´å¬­ç˜¯éœîˆšî•¨**: é™îˆœî›¦é¢ã„¨åšœé”?GC (`auto_gc: None`) æ¸šå¤¸ç°¬ç’‹å†­ç˜¯

---

### é­î…Ÿæ¹¡ (v0.8.0)

## å‚è€ƒèµ„æ–™- [ ] MVCC é˜å¬ªå§å¨´å¬­ç˜¯æ¶“åº¤çšŸæµ¼?

- [ ] æµœã‚†æ§—æµ¼æ¨ºå›ç»¾Ñ†çšŸæ´ï¸¾ç“¥é£ãƒ¥å·±é–?

- [Solana Sealevel å¹¶è¡Œæ‰§è¡Œ](https://medium.com/solana-labs/sealevel-parallel-processing-thousands-of-smart-contracts-d814b378192)- [ ] é‘·î„å§© GC é‘·îˆâ‚¬å‚šç°²ç»›æ «æšé”›å Ÿç‰´é¹î†¿ç¤‹æè—‰å§©é¬ä½½çšŸéæ’®æ£¿é—…æ—“ç´š

- [Aptos Block-STM](https://medium.com/aptoslabs/block-stm-how-we-execute-over-160k-transactions-per-second-on-the-aptos-blockchain-3b003657e4ba)

- [Sui å¹¶è¡Œæ‰§è¡Œæ¨¡å‹](https://docs.sui.io/learn/sui-execution)### æ¶“î…Ÿæ¹¡ (v0.9.0)

- [PostgreSQL MVCC](https://www.postgresql.org/docs/current/mvcc.html)- [ ] æ¶”æ„¯î‡éªè·ºå½‚éºÑƒåŸ—é”›åœ¤CCé”›å¤æ³¦é´?

- [CockroachDB Transaction Layer](https://www.cockroachlabs.com/docs/stable/architecture/transaction-layer.html)- [ ] ç’ºã„¥åé—?é’å——å°¯é¨å‹«è‹Ÿç›å²ƒçšŸæ´ï¸½å¸°ç»±?

- [ ] MVCC æ¶“?Snapshot é‘·î„å§©é–«å¤‹å«¨ç»›æ «æš

---

### é—€æŒæ¹¡ (v1.0.0)

## æ›´æ–°å†å²- [ ] é’å——ç«·å¯®å¿“è‹Ÿç›å±¾å¢½ç›?

- [ ] GPU é”çŠ»â‚¬ç†·å•¿ç»ä½¹î—…å¨´?

- **v0.7.0 (2025-11-04)**: æ·»åŠ  MVCC è‡ªåŠ¨ GCï¼ˆåå°çº¿ç¨‹ï¼‰- [ ] éˆå“„æ«’ç€›ï¸¿ç¯„æµ¼æ¨ºå¯²ç’‹å†¨å®³

- **v0.6.0 (2025-11-04)**: æ·»åŠ  MVCC åƒåœ¾å›æ”¶

- **v0.5.0 (2025-11-04)**: MVCC æ ¸å¿ƒå®ç° + åªè¯»ä¼˜åŒ– + è°ƒåº¦å™¨é›†æˆ---

- **v0.4.0 (2025-11-04)**: æ‰¹é‡æ“ä½œä¼˜åŒ–

- **v0.3.0 (2025-11-03)**: å·¥ä½œçªƒå–è°ƒåº¦å™¨## é™å‚â‚¬å†­ç¥«é‚?

- **v0.2.0 (2025-11-03)**: æ‰§è¡Œç»Ÿè®¡ + è‡ªåŠ¨é‡è¯•

- **v0.1.0 (2025-11-02)**: å¹¶è¡Œæ‰§è¡Œå¼•æ“åˆç‰ˆ- [Solana Sealevel éªæƒ°î”‘éµÑ†î”‘](https://medium.com/solana-labs/sealevel-parallel-processing-thousands-of-smart-contracts-d814b378192)

- [Aptos Block-STM](https://medium.com/aptoslabs/block-stm-how-we-execute-over-160k-transactions-per-second-on-the-aptos-blockchain-3b003657e4ba)

---- [Sui éªæƒ°î”‘éµÑ†î”‘å¦¯â€³ç€·](https://docs.sui.io/learn/sui-execution)

- [PostgreSQL MVCC](https://www.postgresql.org/docs/current/mvcc.html)

*æœ€åæ›´æ–°: 2025-11-04*- [CockroachDB Transaction Layer](https://www.cockroachlabs.com/docs/stable/architecture/transaction-layer.html)


---

## é‡å­˜æŸŠé˜å——å½¶

- **v0.7.0 (2025-11-04)**: å¨£è¯²å§ MVCC é‘·î„å§© GCé”›å æ‚—é™æ‰®åšç»‹å¬¶ç´š
- **v0.6.0 (2025-11-04)**: å¨£è¯²å§ MVCC é¨å†¨æº‡é¥ç‚´æ•¹
- **v0.5.0 (2025-11-04)**: MVCC éç¨¿ç¸¾ç€¹ç‚µå¹‡ + é™î‡î‡°æµ¼æ¨ºå¯² + ç’‹å†¨å®³é£ã„©æ³¦é´?
- **v0.4.0 (2025-11-04)**: éµå½’å™ºé¿å¶„ç¶”æµ¼æ¨ºå¯²
- **v0.3.0 (2025-11-03)**: å®¸ãƒ¤ç¶”ç»å†¨å½‡ç’‹å†¨å®³é£?
- **v0.2.0 (2025-11-03)**: éµÑ†î”‘ç¼ç†»î…¸ + é‘·î„å§©é–²å¶ˆç˜¯
- **v0.1.0 (2025-11-02)**: éªæƒ°î”‘éµÑ†î”‘å¯®æ›Ÿæ¸é’æ¿ˆå¢—

---

*éˆâ‚¬éšåº¢æ´¿é‚? 2025-11-04*




