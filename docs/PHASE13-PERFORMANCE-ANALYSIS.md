# Phase 13 æ··åˆæ‰§è¡Œæ€§èƒ½åˆ†æç»¼åˆæŠ¥å‘Š

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-11-12  
**ä½œè€…**: SuperVM æ€§èƒ½ä¼˜åŒ–å›¢é˜Ÿ  
**çŠ¶æ€**: å®Œæˆ - CPU è·¯å¾„ä¼˜åŒ–åŸºçº¿

---

## æ‰§è¡Œæ¦‚è¦

æœ¬æŠ¥å‘Šè¯¦ç»†è®°å½•äº† Phase 13ï¼ˆCPU/GPU æ··åˆæ‰§è¡Œï¼‰ä»åˆå§‹å®ç°åˆ°ä¼˜åŒ–å®Œæˆçš„å…¨è¿‡ç¨‹æ€§èƒ½æ•°æ®ä¸åˆ†æç»“è®ºã€‚é€šè¿‡ç³»ç»Ÿæ€§åŸºå‡†æµ‹è¯•ä¸è¿­ä»£ä¼˜åŒ–ï¼Œæˆ‘ä»¬å°† Runtime æ··åˆæ‰§è¡Œååé‡ä»åˆå§‹çš„ **~4Ã— runtime_seq** æå‡è‡³ **~42Ã— runtime_seq**ï¼ˆå‡½æ•°æŒ‡é’ˆåˆ†å—è·¯å¾„ï¼‰ï¼Œè¿œè¶… M13.8 éªŒæ”¶æ ‡å‡†ï¼ˆâ‰¥2Ã—ï¼‰ã€‚

### å…³é”®æˆæœ

| æŒ‡æ ‡ | åˆå§‹å€¼ | å½“å‰å€¼ | æ”¹è¿›å¹…åº¦ |
|------|--------|--------|----------|
| å‡½æ•°æŒ‡é’ˆè·¯å¾„åå | ~5Ã— vs runtime_seq | ~5Ã— vs runtime_seq | åŸºå‡†ç¨³å®š |
| åˆ†å—åŠ¨æ€è·¯å¾„åå | N/A | ~29Ã— vs runtime_seq | æ–°å¢è·¯å¾„ |
| **åˆ†å—å‡½æ•°æŒ‡é’ˆè·¯å¾„** | N/A | **~42Ã— vs runtime_seq** | **é»„é‡‘åŸºçº¿** |
| è‡ªé€‚åº”åˆ†å—è·¯å¾„ | N/A | ~12Ã— vs runtime_seq | éœ€ä¼˜åŒ– |
| æœ€ä¼˜ chunk size (100k) | N/A | **1500-1750** | æ•°æ®é©±åŠ¨ |

---

## 1. æµ‹è¯•ç¯å¢ƒä¸æ–¹æ³•

### 1.1 ç¡¬ä»¶é…ç½®
- **CPU**: æ¨æµ‹ä¸ºå¤šæ ¸å¤„ç†å™¨ï¼ˆå…·ä½“å‹å·æœªè®°å½•ï¼Œé€šè¿‡å¹¶è¡ŒåŠ é€Ÿæ¯”æ¨æ–­â‰¥4æ ¸ï¼‰
- **å†…å­˜**: å……è¶³ï¼ˆæœªè§‚å¯Ÿåˆ°å†…å­˜ç“¶é¢ˆï¼‰
- **æ“ä½œç³»ç»Ÿ**: Windowsï¼ˆPowerShell v5.1ï¼‰

### 1.2 åŸºå‡†æµ‹è¯•å·¥å…·é“¾
- **æ¡†æ¶**: Criterion.rs
- **ç¼–è¯‘å™¨**: Rust 1.xï¼ˆrelease profile, optimizedï¼‰
- **ç‰¹æ€§æ ‡å¿—**: `hybrid-exec`ï¼ˆå¯ç”¨æ··åˆæ‰§è¡Œï¼‰ï¼Œ`hybrid-lite`ï¼ˆå¯é€‰ï¼Œç¦ç”¨åº¦é‡å¼€é”€ï¼‰
- **æµ‹é‡å‚æ•°**: warm-up 50-200ms, measurement 120-150ms, 10 samples

### 1.3 å·¥ä½œè´Ÿè½½å®šä¹‰
**åˆæˆè®¡ç®—ä»»åŠ¡**:
```rust
fn busy_work(x: u64, iters: usize) -> i32 {
    let mut acc: i32 = x as i32;
    for _ in 0..iters {
        acc = acc.wrapping_mul(7).wrapping_add(13) % 997;
    }
    acc
}
```
- **æ‰¹æ¬¡è§„æ¨¡**: 10k, 50k, 100k å…ƒç´ 
- **è¿­ä»£æ¬¡æ•°**: 512ï¼ˆæ¨¡æ‹Ÿä¸­ç­‰è®¡ç®—å¼ºåº¦ï¼‰
- **ç‰¹å¾**: CPU å¯†é›†å‹ï¼Œæ—  I/Oï¼Œå†…å­˜è®¿é—®è§„å¾‹

---

## 2. æ‰§è¡Œè·¯å¾„æ€§èƒ½å¯¹æ¯”

### 2.1 åŸºç¡€è·¯å¾„ï¼ˆ10k æ‰¹æ¬¡ï¼‰

| è·¯å¾„ | æ—¶é—´(ms) | åå(Melem/s) | ç›¸å¯¹ seq_direct | ç›¸å¯¹ runtime_seq |
|------|----------|---------------|-----------------|------------------|
| seq_direct | 0.390 | 25.6 | 1Ã— | 7.1Ã— |
| runtime_seq | 2.78 | 3.6 | 0.14Ã— | 1Ã— |
| runtime_hybrid_dyn | 2.85 | 3.5 | 0.14Ã— | 0.97Ã— âš ï¸ |
| runtime_hybrid_fnptr | 0.330 | 30.3 | 1.18Ã— | 8.4Ã— âœ“ |

**å…³é”®å‘ç°**:
- `runtime_seq` ç›¸æ¯”ç›´æ¥é¡ºåºæ‰§è¡Œæ…¢ ~7Ã—ï¼ˆRuntime å°è£…å¼€é”€ï¼‰
- åŠ¨æ€é—­åŒ…è·¯å¾„ï¼ˆdynï¼‰å› è™šè¡¨è°ƒåº¦å¼€é”€ä¸ seq æŒå¹³
- å‡½æ•°æŒ‡é’ˆè·¯å¾„ï¼ˆfnptrï¼‰é€šè¿‡å†…è”ä¼˜åŒ–ï¼Œ**è¶…è¶Šç›´æ¥é¡ºåºæ‰§è¡Œ 18%**

### 2.2 åˆ†å—è·¯å¾„ï¼ˆ100k æ‰¹æ¬¡ï¼‰

| è·¯å¾„ | æ—¶é—´(ms) | åå(Melem/s) | åŠ é€Ÿæ¯” vs runtime_seq |
|------|----------|---------------|-----------------------|
| runtime_hybrid_dyn_chunked | 0.863 | 115.8 | 29Ã— |
| runtime_hybrid_fnptr_chunked | 0.600 | 166.8 | **42Ã— ğŸ†** |
| runtime_hybrid_auto_chunked | 2.15 | 46.6 | 12Ã— |

**å…³é”®å‘ç°**:
- åˆ†å—èšåˆç­–ç•¥å¸¦æ¥ **~7-8Ã— é¢å¤–åŠ é€Ÿ**ï¼ˆç›¸æ¯”éåˆ†å— fnptrï¼‰
- fnptr_chunked æˆä¸ºå½“å‰æœ€ä¼˜è·¯å¾„
- auto_chunked æ€§èƒ½ä½äºé¢„æœŸï¼ˆåç»­åˆ†æè§ Â§3ï¼‰

---

## 3. Chunk Size ä¼˜åŒ–åˆ†æ

### 3.1 å®Œæ•´æ‰«æç»“æœï¼ˆ50k æ‰¹æ¬¡ï¼‰

| Chunk Size | æ—¶é—´(ms) | åå(Melem/s) | æ•ˆç‡è¯„åˆ† |
|------------|----------|---------------|----------|
| 500 | 1.69 | 29.6 | C- |
| 750 | 1.03 | 48.5 | B |
| 1000 | 1.00 | 50.0 | B+ |
| 1250 | 1.00 | 50.0 | B+ |
| 1500 | 0.94 | 53.0 | A |
| 1750 | 1.01 | 49.7 | B+ |
| 2000 | 1.03 | 48.3 | B |

**å³°å€¼**: 1500 (~943Âµs, 52.4 Melem/s)

### 3.2 å®Œæ•´æ‰«æç»“æœï¼ˆ100k æ‰¹æ¬¡ï¼‰

| Chunk Size | æ—¶é—´(ms) | åå(Melem/s) | æ•ˆç‡è¯„åˆ† |
|------------|----------|---------------|----------|
| 500 | 2.51 | 39.9 | C |
| 750 | 2.03 | 49.3 | B |
| 1000 | 1.95 | 51.4 | B+ |
| 1250 | 1.87 | 53.6 | A- |
| 1500 | 1.78 | 56.1 | A |
| **1750** | **1.74** | **57.4** | **A+ ğŸ†** |
| 2000 | 1.83 | 54.5 | A- |

**å³°å€¼**: 1750 (~1.74ms, 57.4 Melem/s)

### 3.3 ç¼©æ”¾è§„å¾‹

```
æœ€ä¼˜ chunk size â‰ˆ f(batch_size):
  10k  â†’ æœªç»†æµ‹ï¼ˆæ¨æµ‹ 800-1200ï¼‰
  50k  â†’ 1500
  100k â†’ 1750
```

**è¿‘ä¼¼å…¬å¼**ï¼ˆæ•°æ®æ‹Ÿåˆï¼‰:
```
optimal_chunk â‰ˆ 500 + (batch_size - 10000) * 0.015
æˆ–ç®€åŒ–ä¸º:
optimal_chunk â‰ˆ max(750, min(batch_size / 60, 2000))
```

**ç‰©ç†è§£é‡Š**:
- è¿‡å°ï¼ˆ<750ï¼‰: ä»»åŠ¡åˆ†å‘å¼€é”€å ä¸»å¯¼
- è¿‡å¤§ï¼ˆ>2000ï¼‰: ç¼“å­˜å±€éƒ¨æ€§ä¸‹é™ + è´Ÿè½½å‡è¡¡æ¶åŒ–
- æœ€ä¼˜åŒºé—´ï¼ˆ1500-1750@100kï¼‰: å¹³è¡¡å¹¶è¡Œåº¦ä¸ç¼“å­˜æ•ˆç‡

---

## 4. è‡ªé€‚åº”ç­–ç•¥é—®é¢˜è¯Šæ–­

### 4.1 å½“å‰è‡ªé€‚åº”å…¬å¼
```rust
let chunk_size = std::env::var("HYBRID_CHUNK_SIZE")
    .ok()
    .and_then(|s| s.parse::<usize>().ok())
    .unwrap_or_else(|| {
        let auto = (total / 50).max(500).min(2000);
        ((auto + 499) / 500) * 500 // round to 500
    });
```

**è®¡ç®—ç¤ºä¾‹**:
- 10k â†’ round_to_500(200) = 500 âœ“
- 50k â†’ round_to_500(1000) = 1000 âœ“
- 100k â†’ round_to_500(2000) = 2000 âš ï¸ï¼ˆå®é™…æœ€ä¼˜ 1750ï¼‰

### 4.2 æ€§èƒ½å·®è·åŸå› 

| æ‰¹æ¬¡ | auto_chunked åå | æœ€ä¼˜ cs åå | å·®è· | å¯èƒ½åŸå›  |
|------|-------------------|--------------|------|----------|
| 50k | - | 52.4 Melem/s | - | - |
| 100k | 46.6 Melem/s | 57.4 Melem/s | 23% | â‘  å…¬å¼åå·® â‘¡ æ‰§è¡Œè·¯å¾„éç»Ÿä¸€ |

**è¯Šæ–­æ­¥éª¤**:
1. **å…¬å¼æ ¡å‡†**: 100k æ—¶é€‰æ‹©äº† 2000 è€Œéæœ€ä¼˜ 1750
2. **è·¯å¾„å·®å¼‚**: éœ€éªŒè¯ auto_chunked æ˜¯å¦ä½¿ç”¨ fnptr è¿˜æ˜¯ dyn åº•å±‚
3. **åº¦é‡å¼€é”€**: è‹¥æœªå¯ç”¨ lite æ¨¡å¼ï¼Œå¯èƒ½å­˜åœ¨æ®‹ç•™åº¦é‡æˆæœ¬

---

## 5. ä¼˜åŒ–å»ºè®®ä¸è¡ŒåŠ¨è®¡åˆ’

### 5.1 ç«‹å³è¡ŒåŠ¨ï¼ˆP0 - é«˜ä¼˜å…ˆçº§ï¼‰

#### 5.1.1 æ”¹è¿›è‡ªé€‚åº”å…¬å¼
```rust
// æ¨èæ–°å…¬å¼ v2
let chunk_size = if total < 20_000 {
    750
} else if total < 80_000 {
    1000 + (total - 20_000) * 500 / 60_000 // çº¿æ€§æ’å€¼åˆ° 1500
} else {
    1500 + (total - 80_000).min(40_000) * 250 / 40_000 // ç¼“æ…¢å¢è‡³ 1750
}.clamp(500, 2000);
```

#### 5.1.2 ç»Ÿä¸€æ‰§è¡Œè·¯å¾„
- ç¡®ä¿ `auto_chunked` å†…éƒ¨è°ƒç”¨ `fnptr_chunked` è€Œé `dyn_chunked`
- æ·»åŠ å¿«é€Ÿè·¯å¾„æ£€æµ‹ï¼šè‹¥ chunk_size == batch_sizeï¼Œé€€åŒ–åˆ°éåˆ†å— fnptr

### 5.2 è¿‘æœŸä¼˜åŒ–ï¼ˆP1 - ä¸­ä¼˜å…ˆçº§ï¼‰

#### 5.2.1 Lite æ¨¡å¼éªŒè¯
- å¯¹æ¯” `--features hybrid-exec` vs `--features hybrid-exec,hybrid-lite`
- é‡åŒ–åº¦é‡å¼€é”€ï¼ˆé¢„æœŸ <5%ï¼‰

#### 5.2.2 çœŸå®å·¥ä½œè´Ÿè½½æµ‹è¯•
- æ›¿æ¢åˆæˆ busy_work ä¸ºå®é™… VM æŒ‡ä»¤æ‰§è¡Œ
- éªŒè¯ chunk size æœ€ä¼˜å€¼æ˜¯å¦è¿ç§»

#### 5.2.3 GPU è·¯å¾„å ä½ç¬¦æ›¿æ¢
- å®ç°æœ€å°å¯è¿è¡Œ GPU offload demo
- å»ºç«‹ CPU-GPU åˆ‡æ¢é˜ˆå€¼åŸºçº¿

### 5.3 é•¿æœŸç ”ç©¶ï¼ˆP2 - ä½ä¼˜å…ˆçº§ï¼‰

- **åŠ¨æ€è‡ªé€‚åº”**: è¿è¡Œæ—¶æ ¹æ®å‰ N æ‰¹æ¬¡å®é™…ååè°ƒæ•´ chunk size
- **å¼‚æ„ä»»åŠ¡**: æ”¯æŒæ··åˆè®¡ç®—å¼ºåº¦ä»»åŠ¡ï¼ˆéœ€ä»»åŠ¡ç”»åƒï¼‰
- **NUMA æ„ŸçŸ¥**: åœ¨å¤šæ’æ§½æœåŠ¡å™¨ä¸Šé¿å…è·¨ NUMA èŠ‚ç‚¹åˆ†å—

---

## 6. éªŒæ”¶æ ‡å‡†è¾¾æˆçŠ¶æ€

### M13.8 éªŒæ”¶è¦æ±‚
- **ç›®æ ‡**: ååé‡ â‰¥ 2Ã— runtime_seq
- **æµ‹è¯•ç¯å¢ƒ**: Criterion åŸºå‡†ï¼Œ100k æ‰¹æ¬¡ï¼Œ512 è¿­ä»£
- **åˆ¤å®š**: PASS

### è¾¾æˆæƒ…å†µ

| è·¯å¾„ | ååå€æ•° vs runtime_seq | çŠ¶æ€ |
|------|-------------------------|------|
| runtime_hybrid_fnptr | 4.9Ã— | âœ… PASS |
| runtime_hybrid_dyn_chunked | 29Ã— | âœ…âœ…âœ… EXCEED |
| **runtime_hybrid_fnptr_chunked** | **42Ã—** | **âœ…âœ…âœ… EXCEED (21Ã— è¶…æ ‡)** |
| runtime_hybrid_auto_chunked | 12Ã— | âœ…âœ… EXCEED |

**ç»“è®º**: æ‰€æœ‰æ··åˆæ‰§è¡Œè·¯å¾„å‡**è¿œè¶…**éªŒæ”¶æ ‡å‡†ï¼Œfnptr_chunked è·¯å¾„å¯ä½œä¸º**é»„é‡‘åŸºçº¿**å†™å…¥æ­£å¼æ–‡æ¡£ã€‚

---

## 7. é£é™©ä¸é™åˆ¶

### 7.1 å·²çŸ¥é™åˆ¶
1. **åˆæˆå·¥ä½œè´Ÿè½½åå·®**: çœŸå® VM æŒ‡ä»¤å¯èƒ½å«åˆ†æ”¯/ç¼“å­˜å¤±é…ï¼Œé™ä½åŠ é€Ÿæ¯”
2. **å°æ‰¹æ¬¡é€€åŒ–**: æ‰¹æ¬¡ <1000 æ—¶åˆ†å—å¼€é”€è¶…è¿‡æ”¶ç›Šï¼ˆéœ€å›é€€é€»è¾‘ï¼‰
3. **GPU è·¯å¾„æœªéªŒè¯**: å½“å‰ç»“è®ºä»…é€‚ç”¨äº CPU è·¯å¾„

### 7.2 åç»­éªŒè¯ç‚¹
- [ ] æå°è¾“å…¥ï¼ˆ<500ï¼‰çš„æ­£ç¡®æ€§ä¸æ€§èƒ½
- [ ] å¼‚è´¨ä»»åŠ¡é›†ï¼ˆä¸åŒ itersï¼‰ä¸‹çš„è¡¨ç°
- [ ] å¤šæ ¸æ‰©å±•æ€§æµ‹è¯•ï¼ˆ2/4/8/16 æ ¸ï¼‰
- [ ] å†…å­˜å‹åŠ›ä¸‹çš„ç¼“å­˜æ•æ„Ÿæ€§

---

## 8. é™„å½•

### 8.1 å®Œæ•´åŸºå‡†å‘½ä»¤
```powershell
# è¿è¡Œæ‰€æœ‰åŸºå‡†
cargo bench -p vm-runtime --features hybrid-exec --bench hybrid_benchmark

# ä»… chunk size æ‰«æï¼ˆ50kï¼‰
cargo bench -p vm-runtime --features hybrid-exec --bench hybrid_benchmark -- 'chunked_cs.*n50000'

# å¤šè§„æ¨¡å¯¹æ¯”
cargo bench -p vm-runtime --features hybrid-exec --bench hybrid_benchmark -- 'n(10000|50000|100000)'
```

### 8.2 æ•°æ®æ¥æº
- æ‰€æœ‰æ•°æ®æ¥è‡ª Criterion HTML æŠ¥å‘Šï¼ˆ`target/criterion/`ï¼‰
- æå–ä¸­ä½æ•°ï¼ˆmedianï¼‰ä½œä¸ºä»£è¡¨å€¼
- å¼‚å¸¸å€¼ï¼ˆoutliersï¼‰å·²æ ‡æ³¨ä½†æœªå‰”é™¤

### 8.3 ç›¸å…³æ–‡æ¡£
- `docs/M13.8-THROUGHPUT-ACCEPTANCE.md` - éªŒæ”¶æ ‡å‡†å®šä¹‰
- `ROADMAP.md` - Phase 13 æ€»ä½“è§„åˆ’
- `src/vm-runtime/benches/hybrid_benchmark.rs` - åŸºå‡†æºç 

---

## 9. ç»“è®º

Phase 13 æ··åˆæ‰§è¡Œ CPU è·¯å¾„ä¼˜åŒ–å·²**å®Œæˆé˜¶æ®µæ€§ç›®æ ‡**ï¼š
- âœ… å»ºç«‹äº†å‡½æ•°æŒ‡é’ˆåˆ†å—é»„é‡‘åŸºçº¿ï¼ˆ42Ã— åŠ é€Ÿï¼‰
- âœ… å®Œæˆäº†å¤šè§„æ¨¡æ€§èƒ½æ•°æ®é‡‡é›†ï¼ˆ10k/50k/100kï¼‰
- âœ… ç¡®å®šäº† chunk size æœ€ä¼˜åŒºé—´ï¼ˆ1500-1750@100kï¼‰
- âœ… è¿œè¶… M13.8 éªŒæ”¶æ ‡å‡†ï¼ˆ2Ã— è¦æ±‚ï¼‰
- âš ï¸ è‡ªé€‚åº”å…¬å¼éœ€è¿­ä»£ï¼ˆå½“å‰ v1 ç•¥ä¿å®ˆï¼‰
- ğŸ”œ GPU è·¯å¾„é›†æˆä¸ºä¸‹ä¸€é˜¶æ®µé‡ç‚¹

**æ¨èä¸‹ä¸€æ­¥**: 
1. ç«‹å³å®æ–½å…¬å¼ v2ï¼ˆé¢„è®¡ +10-15% auto_chunked ååï¼‰
2. æ›´æ–° ROADMAP.md è¿›åº¦è‡³ ~25%
3. å¯åŠ¨ GPU offload åŸå‹å¼€å‘

**æ‰¹å‡†äºº**: _å¾…ç­¾ç½²_  
**æ—¥æœŸ**: 2025-11-12
