# SuperVM 性能配置策略快速参考

## 🎯 核心问题

**Q: 三种场景是根据硬件配置还是应用？要手工配置还是自动调优？**

**A: 综合考虑硬件+应用，推荐半自动模式（应用预设+自适应）**

---

## 📊 三种配置模式对比

| 模式 | 配置难度 | 适用人群 | 性能表现 | 稳定性 | 推荐场景 |
|------|---------|---------|---------|--------|---------|
| **自动模式** 🤖 | ⭐ 零配置 | 运维人员 | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | 初期上线 |
| **半自动模式** ⚙️ | ⭐⭐ 选应用类型 | 开发者 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | **90%生产环境** ✅ |
| **手工模式** 🛠️ | ⭐⭐⭐⭐⭐ 全参数 | 性能专家 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | 极致优化 |

---

## 🚀 推荐配置方案

### 1️⃣ 自动模式 (零配置)

**适用场景**: 初期上线、快速启动

```rust
// 完全自动检测硬件和负载
let coord = TwoPhaseCoordinator::auto_configure(store);
```

**自动检测因素**:
- ✅ CPU核心数 (决定线程数)
- ✅ 内存容量 (决定批量上限)
- ✅ 实时TPS (决定性能模式)
- ✅ 冲突率 (决定锁粒度)

**预期性能**: 400K - 600K TPS

---

### 2️⃣ 半自动模式 (推荐) ⭐

**适用场景**: 90%生产环境

```rust
// 根据应用类型选择预设
let coord = TwoPhaseCoordinator::for_application(
    store,
    ApplicationProfile::DeFi  // 或 NFT, GameFi, Enterprise
);
```

**应用类型映射**:

| 应用类型 | 批量大小 | 冲突阈值 | 锁粒度 | 预期TPS |
|---------|---------|---------|--------|---------|
| **DeFi** | 64 | 3% | 粗粒度 | 900K - 1.2M |
| **NFT** | 32 | 5% | 粗粒度 | 600K - 900K |
| **GameFi** | 32 | 8% | **细粒度** | 700K - 1.0M |
| **Enterprise** | 16 | 5% | 粗粒度 | 300K - 500K |
| **DataLayer** | 96 | 3% | 粗粒度 | 1.0M - 1.2M |

**自动调优特性**:
- ✅ 批量大小根据冲突率动态调整 (8-128)
- ✅ 冲突率 >8% 自动切换细粒度锁
- ✅ 延迟 P99 >20ms 自动降级

**预期性能**: 600K - 1.2M TPS

---

### 3️⃣ 手工模式 (专家)

**适用场景**: 极致性能调优、特殊硬件

```rust
let config = CoordinatorConfig {
    mode: PerformanceMode::HighThroughput,
    threads: 12,
    batch_size: AdaptiveBatchConfig {
        current_size: 48,
        min_size: 16,
        max_size: 96,
        target_conflict_rate: 0.06,
    },
    lock_granularity: LockGranularity::Coarse,
    // ... 更多精细参数
};

let coord = TwoPhaseCoordinator::with_config(store, config);
```

**预期性能**: 900K - 1.2M TPS (需要调优)

---

## 🎯 决策流程

```
选择配置模式
    │
    ├─ 有性能专家？
    │   ├─ 是 → 手工模式 (极致性能)
    │   └─ 否 ↓
    │
    ├─ 业务类型明确？
    │   ├─ 是 → 半自动模式 ✅ (推荐)
    │   │       ├─ DeFi → 大批量低冲突
    │   │       ├─ GameFi → 细粒度锁
    │   │       └─ Enterprise → 保守配置
    │   └─ 否 ↓
    │
    └─ 自动模式 (零配置启动)
```

---

## 📈 三阶段上线策略

### 阶段1: 初期上线 (0-3个月)
```rust
// 自动模式，稳定为主
let coord = TwoPhaseCoordinator::auto_configure(store);
```
**目标**: 400K - 600K TPS

---

### 阶段2: 优化期 (3-6个月)
```rust
// 半自动模式，根据业务选择
let coord = TwoPhaseCoordinator::for_application(
    store,
    ApplicationProfile::DeFi
);
```
**目标**: 600K - 900K TPS

---

### 阶段3: 极限期 (6个月+)
```rust
// 手工模式，基于监控精调
let coord = TwoPhaseCoordinator::with_config(
    store,
    tuned_config_from_metrics()
);
```
**目标**: 900K - 1.2M TPS

---

## 🔍 决定因素详解

### 硬件因素 (决定性能上限)

| 硬件指标 | 影响参数 | 推荐配置 |
|---------|---------|---------|
| **CPU核心数** | 线程池大小 | 0.75 × 核心数 |
| **内存容量** | 批量上限 | 16GB → 64批量 |
| **网络带宽** | 跨分片并发 | 10Gbps → 8分片 |

**示例**:
- 8核16GB → 6线程, 批量32-64
- 16核32GB → 12线程, 批量64-96
- 4核8GB → 3线程, 批量16-32

---

### 应用因素 (决定优化策略)

| 应用类型 | 冲突特征 | 优化策略 | 批量大小 | 锁粒度 |
|---------|---------|---------|---------|--------|
| **DeFi** | 低冲突 (1-3%) | 大批量吞吐 | 64-96 | 粗粒度 |
| **NFT** | 中等冲突 (3-5%) | 平衡配置 | 32-48 | 粗粒度 |
| **GameFi** | 高冲突 (5-10%) | 细粒度锁 | 16-32 | **细粒度** |
| **支付** | 极低冲突 (<1%) | 超大批量 | 96-128 | 粗粒度 |
| **企业链** | 稳定优先 | 保守配置 | 16-24 | 粗粒度 |

---

## ⚙️ 自动调优范围

| 参数 | 自动化程度 | 调整范围 | 触发条件 |
|------|-----------|---------|---------|
| **批量大小** | ✅ 完全自动 | 8-128 | 冲突率偏离目标 |
| **锁粒度** | ⚠️ 半自动 | 粗/细 | 冲突率 >8% |
| **线程数** | ❌ 手动固定 | - | 避免抖动 |
| **性能模式** | ⚠️ 降级保护 | 3种模式 | 延迟 P99 >20ms |

**自适应批量算法**:
```rust
if conflict_rate < target × 0.8 {
    batch_size *= 1.2  // 增大批量 20%
} else if conflict_rate > target × 1.5 {
    batch_size *= 0.8  // 减小批量 20%
}
batch_size.clamp(min_size, max_size)
```

---

## 📊 性能预期参考

### 按硬件配置

| 硬件配置 | 预期TPS | 推荐模式 | 应用场景 |
|---------|---------|---------|---------|
| 4核8GB | 300K - 500K | 保守/自动 | 测试环境 |
| 8核16GB | 600K - 900K | 标准/半自动 | 中型链 |
| 16核32GB | 900K - 1.2M | 高性能/手工 | 大型链 |

### 按应用类型

| 应用类型 | 典型负载 | 预期TPS | 推荐配置 |
|---------|---------|---------|---------|
| DeFi DEX | 高频交易 | 900K - 1.2M | 半自动 (DeFi) |
| NFT市场 | 突发铸造 | 600K - 900K | 半自动 (NFT) |
| 链游 | 高并发 | 700K - 1.0M | 半自动 (GameFi) |
| 供应链 | 稳定流量 | 300K - 500K | 半自动 (Enterprise) |

---

## 🎯 一句话总结

> **默认使用半自动模式** (选择应用类型即可)，  
> 批量大小自动调优，锁粒度冲突驱动，  
> **99%场景无需手工配置，轻松达到 600K - 1.2M TPS！**

---

## 📚 相关文档

- [ROADMAP.md - 实际区块链场景性能预期](../ROADMAP.md#实际区块链场景性能预期)
- [ROADMAP.md - 场景选择与配置策略](../ROADMAP.md#场景选择与配置策略)
- [concurrent_batch_2pc_bench.rs](../../src/vm-runtime/examples/concurrent_batch_2pc_bench.rs) - 基准测试代码

---

**更新日期**: 2025-11-11  
**测试基准**: 100K事务, 8线程, 批量32  
**最佳成绩**: 1.19M TPS (多线程并发批量模式)
