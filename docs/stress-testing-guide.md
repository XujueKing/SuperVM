# MVCC 鍘嬪姏娴嬭瘯涓庤皟浼樻寚鍗?(v0.8.0)

鐗堟湰: v0.8.0  
鏃ユ湡: 2025-11-04

## 鐩綍

- [姒傝堪](#姒傝堪)
- [鍘嬪姏娴嬭瘯濂椾欢](#鍘嬪姏娴嬭瘯濂椾欢)
- [娴嬭瘯鍦烘櫙](#娴嬭瘯鍦烘櫙)
- [鑷€傚簲 GC](#鑷€傚簲-gc)
- [鎬ц兘璋冧紭寤鸿](#鎬ц兘璋冧紭寤鸿)
- [鏁呴殰鎺掓煡](#鏁呴殰鎺掓煡)

---

## 姒傝堪

鏈寚鍗椾粙缁嶅浣曚娇鐢?MVCC 鍘嬪姏娴嬭瘯濂椾欢鏉ヨ瘎浼扮郴缁熸€ц兘锛屼互鍙婂浣曟牴鎹祴璇曠粨鏋滆繘琛岃皟浼樸€?

### 涓轰粈涔堥渶瑕佸帇鍔涙祴璇曪紵

- **楠岃瘉绋冲畾鎬?*: 纭繚楂樿礋杞戒笅绯荤粺涓嶄細宕╂簝鎴栧唴瀛樻硠婕?
- **璇勪及鎬ц兘**: 浜嗚В绯荤粺鐨勫悶鍚愰噺鍜屽欢杩熺壒鎬?
- **浼樺寲閰嶇疆**: 鎵惧埌鏈€閫傚悎鎮ㄥ伐浣滆礋杞界殑 GC 鍙傛暟
- **鍙戠幇鐡堕**: 璇嗗埆鎬ц兘鐡堕鍜屼紭鍖栨満浼?

---

## 鍘嬪姏娴嬭瘯濂椾欢

### 杩愯鎵€鏈夋祴璇?

```bash
# 杩愯鎵€鏈夊揩閫熸祴璇曪紙鎺掗櫎闀挎椂闂存祴璇曪級
cargo test -p vm-runtime --test mvcc_stress_test -- --test-threads=1 --nocapture

# 杩愯鍖呮嫭闀挎椂闂存祴璇?
cargo test -p vm-runtime --test mvcc_stress_test -- --test-threads=1 --nocapture --ignored
```

### 鍙敤娴嬭瘯

| 娴嬭瘯鍚嶇О | 鎻忚堪 | 杩愯鏃堕棿 |
|---------|------|---------|
| `test_high_concurrency_mixed_workload` | 楂樺苟鍙戞贩鍚堣鍐欙紙8绾跨▼锛?000浜ゆ槗锛?| ~1绉?|
| `test_high_contention_hotspot` | 楂樺啿绐佺儹鐐归敭锛?6绾跨▼锛?涓儹鐐归敭锛?| ~1绉?|
| `test_memory_growth_control` | 鍐呭瓨澧為暱鐩戞帶锛?0閿紝20杩唬锛?| ~10绉?|
| `test_adaptive_gc` | 鑷€傚簲 GC 琛屼负楠岃瘉 | ~20绉?|
| `test_long_running_stability` | 闀挎椂闂寸ǔ瀹氭€э紙60绉掞紝鍙厤缃級 | 60绉? |

---

## 娴嬭瘯鍦烘櫙

### 1. 楂樺苟鍙戞贩鍚堣鍐欐祴璇?

**鐩殑**: 璇勪及娣峰悎璇诲啓璐熻浇涓嬬殑鎬ц兘

**閰嶇疆**:
```rust
- 绾跨▼鏁? 8
- 姣忕嚎绋嬩氦鏄撴暟: 1000
- 鎬婚敭鏁? 100
- 璇绘瘮渚? 70%
- 鍐欐瘮渚? 30%
```

**棰勬湡缁撴灉**:
- 鍚炲悙閲? > 100,000 TPS
- 鎴愬姛鐜? > 99%
- 鍐茬獊鐜? < 1%
- 骞冲潎寤惰繜: < 20 渭s

**绀轰緥杈撳嚭**:
```
鈺斺晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺?
鈺?        MVCC 鍘嬪姏娴嬭瘯鎶ュ憡                                  鈺?
鈺犫晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺?
鈺?鎬讳氦鏄撴暟:           8000 绗?                             鈺?
鈺?鎴愬姛浜ゆ槗:           7983 绗?(99.8%)                     鈺?
鈺?澶辫触浜ゆ槗:             17 绗?(0.2%)                     鈺?
鈺?鍐茬獊鏁?               17 娆?                             鈺?
鈺犫晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺?
鈺?鍚炲悙閲?        729634.09 TPS                           鈺?
鈺?骞冲潎寤惰繜:           8.02 渭s                            鈺?
鈺?P99 寤惰繜:          59.00 渭s                            鈺?
鈺氣晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺?
```

### 2. 楂樺啿绐佺儹鐐归敭娴嬭瘯

**鐩殑**: 璇勪及鍦ㄦ瀬绔啿绐佸満鏅笅鐨勮〃鐜?

**閰嶇疆**:
```rust
- 绾跨▼鏁? 16
- 姣忕嚎绋嬩氦鏄撴暟: 500
- 鐑偣閿暟: 5
- 璇诲啓妯″紡: 璇?淇敼-鍐?
```

**棰勬湡缁撴灉**:
- 鍚炲悙閲? > 50,000 TPS
- 鎴愬姛鐜? > 95%
- 鍐茬獊鐜? 1-5%
- 鏈€缁堟暟鎹纭€? 100%

**绀轰緥杈撳嚭**:
```
鐑偣閿?hot_0 鏈€缁堝€? 522
鐑偣閿?hot_1 鏈€缁堝€? 589
鐑偣閿?hot_2 鏈€缁堝€? 507
...
鍐茬獊鐜? 1.9%
```

### 3. 鍐呭瓨澧為暱鎺у埗娴嬭瘯

**鐩殑**: 楠岃瘉 GC 鑳芥湁鏁堟帶鍒跺唴瀛樺闀?

**閰嶇疆**:
```rust
- 閿暟: 50
- 杩唬娆℃暟: 20
- GC 闂撮殧: 2绉?
- 鐗堟湰闃堝€? 500
```

**棰勬湡缁撴灉**:
- 鐗堟湰鏁扮ǔ瀹氬湪 `閿暟 脳 max_versions_per_key` 闄勮繎
- GC 瀹氭湡鎵ц锛堣嚦灏?2 娆★級
- 鍐呭瓨涓嶄細鏃犻檺澧為暱

**绀轰緥杈撳嚭**:
```
杩唬  1: 鐗堟湰鏁?=   50, 閿暟 =  50, 骞冲潎鐗堟湰/閿?= 1.00
杩唬  2: 鐗堟湰鏁?=  100, 閿暟 =  50, 骞冲潎鐗堟湰/閿?= 2.00
...
杩唬 14: 鐗堟湰鏁?=  550, 閿暟 =  50, 骞冲潎鐗堟湰/閿?= 11.00
杩唬 15: 鐗堟湰鏁?=  600, 閿暟 =  50, 骞冲潎鐗堟湰/閿?= 12.00

鉁?娴嬭瘯瀹屾垚
鏈€缁堢増鏈暟: 650
GC 鎵ц娆℃暟: 2
GC 娓呯悊鐗堟湰: 350
```

### 4. 闀挎椂闂寸ǔ瀹氭€ф祴璇?

**鐩殑**: 楠岃瘉闀挎椂闂磋繍琛岀殑绋冲畾鎬?

**閰嶇疆**:
```rust
- 杩愯鏃堕暱: 60绉掞紙鍙厤缃负鏁板皬鏃讹級
- 绾跨▼鏁? 4
- 閿暟: 200
- 璇诲啓姣斾緥: 50/50
```

**鐩戞帶鎸囨爣**:
- 瀹炴椂 TPS
- 鐗堟湰鏁板彉鍖?
- GC 鎵ц棰戠巼
- 鍐呭瓨鍗犵敤

**绀轰緥杈撳嚭**:
```
[10s] TPS: 5810, 鐗堟湰鏁? 58301, 閿暟: 200, GC 娆℃暟: 0
[20s] TPS: 5824, 鐗堟湰鏁? 58302, 閿暟: 200, GC 娆℃暟: 1
[30s] TPS: 5831, 鐗堟湰鏁? 58305, 閿暟: 200, GC 娆℃暟: 2
...
```

---

## 鑷€傚簲 GC

### 浠€涔堟槸鑷€傚簲 GC锛?

鑷€傚簲 GC 鏍规嵁绯荤粺璐熻浇鍜屽唴瀛樺帇鍔涘姩鎬佽皟鏁?GC 鍙傛暟锛屾棤闇€鎵嬪姩璋冧紭銆?

### 閰嶇疆鑷€傚簲 GC

```rust
use vm_runtime::{MvccStore, GcConfig, AutoGcConfig, AdaptiveGcStrategy};

let config = GcConfig {
    max_versions_per_key: 20,
    enable_time_based_gc: false,
    version_ttl_secs: 3600,
    auto_gc: Some(AutoGcConfig {
        interval_secs: 60,          // 鍩哄噯闂撮殧
        version_threshold: 1000,    // 鍩哄噯闃堝€?
        run_on_start: false,
        enable_adaptive: true,      // 馃幆 鍚敤鑷€傚簲
    }),
};

let store = MvccStore::new_with_config(config);
```

### 鑷€傚簲绛栫暐

```rust
pub struct AdaptiveGcStrategy {
    pub base_interval_secs: 60,    // 鍩哄噯闂撮殧
    pub min_interval_secs: 10,     // 鏈€灏忛棿闅旓紙楂樿礋杞斤級
    pub max_interval_secs: 300,    // 鏈€澶ч棿闅旓紙浣庤礋杞斤級
    pub base_threshold: 1000,      // 鍩哄噯闃堝€?
    pub min_threshold: 500,        // 鏈€灏忛槇鍊硷紙鏇存縺杩涳級
    pub max_threshold: 5000,       // 鏈€澶ч槇鍊硷紙鏇村鏉撅級
}
```

### 璋冩暣閫昏緫

1. **楂樿礋杞芥娴?*锛堥珮 TPS 鎴栫増鏈揩閫熷闀匡級:
   - 鉁?缂╃煭 GC 闂撮殧
   - 鉁?闄嶄綆瑙﹀彂闃堝€?
   - 馃幆 鏇撮绻併€佹洿婵€杩涚殑 GC

2. **浣庢晥 GC 妫€娴?*锛堟竻鐞嗙巼 < 10%锛?
   - 鉁?寤堕暱 GC 闂撮殧
   - 鉁?鎻愰珮瑙﹀彂闃堝€?
   - 馃幆 鍑忓皯鏃犳晥 GC锛岃妭鐪佽祫婧?

3. **姝ｅ父璐熻浇**:
   - 鉁?閫愭笎鍥炲綊鍩哄噯鍊?
   - 馃幆 淇濇寔绋冲畾鐘舵€?

### 鑷€傚簲 GC 娴嬭瘯

杩愯鑷€傚簲 GC 娴嬭瘯:
```bash
cargo test -p vm-runtime --test mvcc_stress_test test_adaptive_gc -- --nocapture
```

瑙傚療杈撳嚭锛岀‘璁?
- GC 鍦ㄩ珮璐熻浇鏃舵洿棰戠箒鎵ц
- 鐗堟湰鏁拌鏈夋晥鎺у埗
- 浣庤礋杞芥椂 GC 棰戠巼闄嶄綆

### 杩愯鏃惰娴?

**瀹炴椂鏌ョ湅 GC 鍙傛暟**锛坴0.8.0+锛?

```rust
if let Some(runtime) = store.get_auto_gc_runtime() {
    println!(
        "鑷€傚簲妯″紡: {}, 褰撳墠闂撮殧: {}s, 褰撳墠闃堝€? {}",
        runtime.enable_adaptive,
        runtime.interval_secs,
        runtime.version_threshold
    );
}
```

缁撳悎 GC 缁熻璇勪及鏁堟灉:

```rust
let stats = store.get_gc_stats();
let runtime = store.get_auto_gc_runtime().unwrap();
println!(
    "GC 鎵ц {} 娆? 娓呯悊 {} 鐗堟湰, 褰撳墠闂撮殧 {}s, 褰撳墠闃堝€?{}",
    stats.gc_count,
    stats.versions_cleaned,
    runtime.interval_secs,
    runtime.version_threshold
);
```

> 馃摉 璇︾粏璇存槑璇峰弬鑰? [GC 杩愯鏃跺彲瑙傛祴鎬ф枃妗(gc-observability.md)

---

## 鎬ц兘璋冧紭寤鸿

### 鍩轰簬娴嬭瘯缁撴灉璋冧紭

#### 鍦烘櫙 1: 楂樺悶鍚愰噺瑕佹眰

**闂**: 闇€瑕佹渶澶у寲 TPS

**寤鸿**:
```rust
GcConfig {
    max_versions_per_key: 30,      // 猬嗭笍 澧炲姞鐗堟湰闄愬埗
    auto_gc: Some(AutoGcConfig {
        interval_secs: 120,        // 猬嗭笍 寤堕暱闂撮殧
        version_threshold: 2000,   // 猬嗭笍 鎻愰珮闃堝€?
        enable_adaptive: true,     // 鉁?鍚敤鑷€傚簲
    }),
}
```

**鍘熺悊**: 鍑忓皯 GC 棰戠巼锛岄檷浣庡紑閿€

---

#### 鍦烘櫙 2: 鍐呭瓨鏁忔劅鍦烘櫙

**闂**: 鍐呭瓨鏈夐檺锛岄渶瑕佷弗鏍兼帶鍒?

**寤鸿**:
```rust
GcConfig {
    max_versions_per_key: 10,      // 猬囷笍 闄嶄綆鐗堟湰闄愬埗
    auto_gc: Some(AutoGcConfig {
        interval_secs: 30,         // 猬囷笍 缂╃煭闂撮殧
        version_threshold: 500,    // 猬囷笍 闄嶄綆闃堝€?
        enable_adaptive: true,     // 鉁?鍚敤鑷€傚簲
    }),
}
```

**鍘熺悊**: 鏇存縺杩涚殑 GC锛屽揩閫熷洖鏀跺唴瀛?

---

#### 鍦烘櫙 3: 楂樺啿绐佸満鏅?

**闂**: 鐑偣閿鑷村ぇ閲忓啿绐?

**寤鸿**:
```rust
GcConfig {
    max_versions_per_key: 50,      // 猬嗭笍 鐑偣閿渶瑕佹洿澶氱増鏈?
    auto_gc: Some(AutoGcConfig {
        interval_secs: 60,
        version_threshold: 1000,
        enable_adaptive: true,     // 鉁?璁╄嚜閫傚簲澶勭悊
    }),
}

// 鍚屾椂鑰冭檻搴旂敤灞備紭鍖栵細
// 1. 閿垎鐗囷紙鍑忓皯鐑偣锛?
// 2. 鎵归噺鎿嶄綔锛堝噺灏戝啿绐侊級
// 3. 鍙浜嬪姟锛堜娇鐢ㄥ揩閫熻矾寰勶級
```

---

#### 鍦烘櫙 4: 闀夸簨鍔″満鏅?

**闂**: 鏈夐暱鏃堕棿杩愯鐨勪簨鍔?

**寤鸿**:
```rust
GcConfig {
    max_versions_per_key: 100,     // 猬嗭笍猬嗭笍 澶у箙澧炲姞
    auto_gc: Some(AutoGcConfig {
        interval_secs: 180,        // 猬嗭笍 寤堕暱闂撮殧
        version_threshold: 5000,   // 猬嗭笍 鎻愰珮闃堝€?
        enable_adaptive: false,    // 鉂?绂佺敤锛堥伩鍏嶈鍒わ級
    }),
}
```

**鍘熺悊**: 淇濈暀瓒冲澶氱殑鐗堟湰渚涢暱浜嬪姟璇诲彇

---

### 鐩戞帶鎸囨爣

杩愯鍘嬪姏娴嬭瘯鏃跺叧娉?

1. **鍚炲悙閲?(TPS)**:
   - 楂樺苟鍙? > 100K TPS
   - 楂樺啿绐? > 50K TPS

2. **寤惰繜**:
   - 骞冲潎: < 20 渭s
   - P99: < 100 渭s

3. **鎴愬姛鐜?*:
   - 娣峰悎璐熻浇: > 99%
   - 楂樺啿绐? > 95%

4. **鍐呭瓨**:
   - 鐗堟湰鏁? < 閿暟 脳 max_versions_per_key 脳 1.5
   - GC 娓呯悊鐜? > 10%

---

## 鏁呴殰鎺掓煡

### 闂 1: 鍐呭瓨鎸佺画澧為暱

**鐥囩姸**: 鐗堟湰鏁颁笉鏂鍔狅紝GC 鏃犳晥

**鍙兘鍘熷洜**:
- GC 闂撮殧澶暱
- 鐗堟湰闃堝€煎お楂?
- 鏈夐暱鏃堕棿鏈彁浜ょ殑浜嬪姟

**瑙ｅ喅鏂规**:
```rust
// 1. 闄嶄綆 GC 闂撮殧鍜岄槇鍊?
interval_secs: 30,
version_threshold: 500,

// 2. 妫€鏌ユ椿璺冧簨鍔?
let min_ts = store.get_min_active_ts();
println!("鏈€灏忔椿璺冧簨鍔? {:?}", min_ts);

// 3. 纭繚鎵€鏈変簨鍔″強鏃舵彁浜ゆ垨鍥炴粴
```

---

### 闂 2: 鍚炲悙閲忎笅闄?

**鐥囩姸**: TPS 杩滀綆浜庨鏈?

**鍙兘鍘熷洜**:
- GC 澶绻?
- 楂樺啿绐佺巼
- 閿佺珵浜?

**瑙ｅ喅鏂规**:
```rust
// 1. 寤堕暱 GC 闂撮殧
interval_secs: 120,

// 2. 鍚敤鑷€傚簲 GC
enable_adaptive: true,

// 3. 浣跨敤鍙浜嬪姟浼樺寲璇绘搷浣?
let ro_txn = store.begin_read_only();
```

---

### 闂 3: 楂樺啿绐佺巼

**鐥囩姸**: 澶ч噺浜嬪姟澶辫触

**鍙兘鍘熷洜**:
- 鐑偣閿闂?
- 鐗堟湰鏁颁笉瓒?
- 浜嬪姟绮掑害澶ぇ

**瑙ｅ喅鏂规**:
```rust
// 1. 澧炲姞鐗堟湰闄愬埗
max_versions_per_key: 50,

// 2. 搴旂敤灞傚垎鐗?
let shard = hash(key) % num_shards;
let sharded_key = format!("{}_{}", key, shard);

// 3. 缂╁皬浜嬪姟鑼冨洿
// 灏嗗ぇ浜嬪姟鎷嗗垎涓哄涓皬浜嬪姟
```

---

### 闂 4: P99 寤惰繜楂?

**鐥囩姸**: 骞冲潎寤惰繜姝ｅ父锛屼絾 P99 寰堥珮

**鍙兘鍘熷洜**:
- GC 鏆傚仠
- 閿佺瓑寰?
- 鐗堟湰閾捐繃闀?

**瑙ｅ喅鏂规**:
```rust
// 1. 鏇存縺杩涚殑 GC
max_versions_per_key: 15,
version_threshold: 800,

// 2. 鐩戞帶 GC 鎵ц
let stats = store.get_gc_stats();
println!("GC 棰戠巼: {} 娆?鍒嗛挓", 
    stats.gc_count as f64 / elapsed_minutes);
```

---

## 鎬荤粨

鉁?**鍘嬪姏娴嬭瘯鏄繀闇€鐨?*  
鍦ㄧ敓浜х幆澧冮儴缃插墠锛屽姟蹇呰繍琛屽畬鏁寸殑鍘嬪姏娴嬭瘯濂椾欢

鉁?**鑷€傚簲 GC 鏄閫?*  
瀵逛簬澶у鏁板満鏅紝鍚敤鑷€傚簲 GC 鍙互鑷姩浼樺寲鎬ц兘

鉁?**鐩戞帶鏄叧閿?*  
鎸佺画鐩戞帶 TPS銆佸欢杩熴€佺増鏈暟鍜?GC 缁熻

鉁?**鏍规嵁宸ヤ綔璐熻浇璋冧紭**  
涓嶅悓鍦烘櫙闇€瑕佷笉鍚岀殑閰嶇疆锛屼娇鐢ㄦ湰鎸囧崡浣滀负璧风偣

---

## 涓嬩竴姝?

- 鏌ョ湅 [骞惰鎵ц璁捐鏂囨。](parallel-execution.md)
- 鏌ョ湅 [Demo 绀轰緥](../../src/node-core/examples/)
- 鏌ョ湅 [鍩哄噯娴嬭瘯鎶ュ憡](../../BENCHMARK_RESULTS.md)

---

*鏈€鍚庢洿鏂? 2025-11-04*




