name: Kernel Purity & Performance Check

on:
  pull_request:
    paths:
      - 'src/vm-runtime/**'
      - 'Cargo.toml'
  push:
    branches:
      - main
      - develop

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always

jobs:
  # Job 1: L0/L1 å†…æ ¸ä¿®æ”¹æ£€æµ‹
  kernel-modification-check:
    name: ðŸ” Kernel Modification Detection
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0  # èŽ·å–å®Œæ•´åŽ†å²
      
      - name: è¯»å–ç»´æŠ¤è€…ç™½åå•
        id: maintainers
        run: |
          if [ -f .github/MAINTAINERS ]; then
            echo "maintainers=$(cat .github/MAINTAINERS | tr '\n' ' ' )" >> $GITHUB_OUTPUT
          else
            echo "maintainers=" >> $GITHUB_OUTPUT
          fi
      
      - name: æ£€æµ‹ L0 å†…æ ¸ä¿®æ”¹
        id: l0_check
        run: |
          L0_PATTERNS=(
            "src/vm-runtime/src/lib.rs"
            "src/vm-runtime/src/runtime.rs"
            "src/vm-runtime/src/wasm_executor.rs"
            "src/vm-runtime/src/storage.rs"
            "src/vm-runtime/src/parallel/"
            "src/vm-runtime/src/mvcc/"
          )
          
          CHANGED_FILES=$(git diff --name-only origin/main...HEAD)
          L0_MODIFIED=0
          
          for pattern in "${L0_PATTERNS[@]}"; do
            if echo "$CHANGED_FILES" | grep -q "^$pattern"; then
              echo "âš ï¸  L0 file modified: $pattern"
              L0_MODIFIED=1
            fi
          done
          
          echo "l0_modified=$L0_MODIFIED" >> $GITHUB_OUTPUT

      - name: æ£€æµ‹æ˜¯å¦å­˜åœ¨ç»´æŠ¤è€…è¦†ç›– (æ ‡ç­¾ã€æ–‡ä»¶æˆ–åˆ†æ”¯å)
        id: override
        if: github.event_name == 'pull_request'
        run: |
          echo "override=0" >> $GITHUB_OUTPUT
          OVERRIDE_REASON=""
          
          # æ£€æŸ¥ PR æ ‡ç­¾æ˜¯å¦åŒ…å« override-l0
          if command -v jq >/dev/null 2>&1; then
            HAS_LABEL=$(jq -r '.pull_request.labels | map(.name) | index("override-l0")' "$GITHUB_EVENT_PATH")
            if [ "$HAS_LABEL" != "null" ]; then
              echo "label_found=1" >> $GITHUB_OUTPUT
              OVERRIDE_REASON="PR label override-l0"
            fi
          fi
          
          # æ£€æŸ¥ä»“åº“ä¸­æ˜¯å¦å­˜åœ¨è¦†ç›–æ–‡ä»¶
          if [ -f .github/OVERRIDE-L0 ] || [ -f .kernel-override ]; then
            echo "file_found=1" >> $GITHUB_OUTPUT
            OVERRIDE_REASON="${OVERRIDE_REASON:+$OVERRIDE_REASON, }override file"
          fi
          
          # æ£€æŸ¥åˆ†æ”¯åæ˜¯å¦ä¸ºä¸Šå¸åˆ†æ”¯ (king/* æˆ– main)
          HEAD_REF="${{ github.head_ref }}"
          if [[ "$HEAD_REF" =~ ^king/ ]] || [ "$HEAD_REF" = "main" ]; then
            echo "god_branch=1" >> $GITHUB_OUTPUT
            OVERRIDE_REASON="${OVERRIDE_REASON:+$OVERRIDE_REASON, }god branch: $HEAD_REF"
          fi
          
          # æ ¡éªŒæäº¤è€…æ˜¯å¦ç»´æŠ¤è€…
          ACTOR="${{ github.actor }}"
          MAINTAINERS_STR="${{ steps.maintainers.outputs.maintainers }}"
          if echo "$MAINTAINERS_STR" | grep -qi "$ACTOR"; then
            echo "actor_is_maintainer=1" >> $GITHUB_OUTPUT
          fi
          
          # è®¡ç®— override (ä»»ä¸€æ¡ä»¶æ»¡è¶³ä¸”ä¸ºç»´æŠ¤è€…)
          if { [ "$HAS_LABEL" != "" ] && [ "$HAS_LABEL" != "null" ]; } || [ -f .github/OVERRIDE-L0 ] || [ -f .kernel-override ] || [[ "$HEAD_REF" =~ ^king/ ]] || [ "$HEAD_REF" = "main" ]; then
            if echo "$MAINTAINERS_STR" | grep -qi "$ACTOR"; then
              echo "override=1" >> $GITHUB_OUTPUT
              echo "override_reason=$OVERRIDE_REASON" >> $GITHUB_OUTPUT
            fi
          fi
      
      - name: æ£€æµ‹ L1 æ‰©å±•ä¿®æ”¹
        id: l1_check
        run: |
          L1_PATTERNS=(
            "src/vm-runtime/src/ownership.rs"
            "src/vm-runtime/src/supervm.rs"
            "src/vm-runtime/src/execution_trait.rs"
          )
          
          CHANGED_FILES=$(git diff --name-only origin/main...HEAD)
          L1_MODIFIED=0
          
          for pattern in "${L1_PATTERNS[@]}"; do
            if echo "$CHANGED_FILES" | grep -q "^$pattern"; then
              echo "âš ï¸  L1 file modified: $pattern"
              L1_MODIFIED=1
            fi
          done
          
          echo "l1_modified=$L1_MODIFIED" >> $GITHUB_OUTPUT
      
      - name: L0 ä¿®æ”¹è­¦å‘Š/è¦†ç›–
        if: steps.l0_check.outputs.l0_modified == '1' && steps.override.outputs.override != '1'
        run: |
          echo "::error::ðŸš¨ L0 CRITICAL MODIFICATION DETECTED"
          echo "::error::This PR modifies L0 core kernel files"
          echo "::error::Required: Architect + 2 core developers approval"
          echo "::error::See: docs/KERNEL-DEFINITION.md Section 4.1"
          exit 1

      - name: ç»´æŠ¤è€…è¦†ç›–å·²å¯ç”¨ (ä»…è­¦å‘Š)
        if: steps.l0_check.outputs.l0_modified == '1' && steps.override.outputs.override == '1'
        run: |
          echo "::warning::âš ï¸  Maintainer override enabled for L0 changes"
          echo "::warning::Actor: ${{ github.actor }}"
          echo "::warning::Reason: ${{ steps.override.outputs.override_reason }}"
          echo "::warning::Please ensure all approvals and tests are completed before merging."
      
      - name: L1 ä¿®æ”¹è­¦å‘Š
        if: steps.l1_check.outputs.l1_modified == '1'
        run: |
          echo "::warning::âš ï¸  L1 EXTENSION MODIFICATION DETECTED"
          echo "::warning::Required: 1 core developer approval"
          echo "::warning::See: docs/KERNEL-DEFINITION.md Section 4.2"

  # Job 2: ä¾èµ–çº¯å‡€åº¦æ£€æŸ¥
  dependency-purity-check:
    name: ðŸ§ª Dependency Purity Check
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: å®‰è£… Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
      
      - name: æ£€æŸ¥ç¦æ­¢ä¾èµ–
        run: |
          echo "ðŸ” Checking for forbidden dependencies in vm-runtime..."
          
          FORBIDDEN=("revm" "ethers" "web3" "tokio")
          FOUND_FORBIDDEN=0
          
          for dep in "${FORBIDDEN[@]}"; do
            if grep -q "^$dep = " src/vm-runtime/Cargo.toml; then
              echo "::error::âŒ Forbidden dependency found: $dep"
              echo "::error::Kernel must not depend on EVM or async runtime"
              FOUND_FORBIDDEN=1
            fi
          done
          
          if [ $FOUND_FORBIDDEN -eq 1 ]; then
            exit 1
          fi
          
          echo "âœ… No forbidden dependencies found"
      
      - name: çº¯å‡€å†…æ ¸æž„å»ºæµ‹è¯•
        run: |
          echo "ðŸ—ï¸  Building pure kernel (no default features)..."
          cd src/vm-runtime
          cargo build --no-default-features --verbose
          
          echo "âœ… Pure kernel build successful"

  # Job 3: å•å…ƒæµ‹è¯•
  unit-tests:
    name: ðŸ§ª Unit Tests
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: å®‰è£… Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
      
      - name: è¿è¡Œå†…æ ¸æµ‹è¯•
        run: |
          cargo test -p vm-runtime --verbose
      
      - name: è¿è¡Œå®Œæ•´æµ‹è¯•
        run: |
          cargo test --workspace --verbose

  # Job 4: æ€§èƒ½åŸºå‡†æµ‹è¯•
  performance-benchmarks:
    name: âš¡ Performance Benchmarks
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: å®‰è£… Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
      
      - name: å®‰è£… Criterion
        run: cargo install cargo-criterion || true
      
      - name: è¿è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•
        run: |
          echo "âš¡ Running performance benchmarks..."
          
          # è¿è¡Œ vm-runtime å¹¶è¡Œ/GC/MVCC åŸºå‡†æµ‹è¯•
          # æ³¨æ„ï¼šå½“å‰ä»“åº“å­˜åœ¨çš„åŸºå‡†æ–‡ä»¶ä¸º src/vm-runtime/benches/parallel_benchmark.rs
          cargo bench -p vm-runtime --bench parallel_benchmark -- --save-baseline current
      
      - name: å¯¹æ¯”åŸºå‡†æ€§èƒ½
        if: github.event_name == 'pull_request'
        continue-on-error: true
        run: |
          echo "ðŸ“Š Comparing with baseline..."
          
          # æ£€å‡º main åˆ†æ”¯
          git checkout origin/main
          
          # è¿è¡ŒåŸºå‡†æµ‹è¯•ï¼ˆä¸Ž main åŸºçº¿ä¸€è‡´çš„åŸºå‡†ï¼‰
          cargo bench -p vm-runtime --bench parallel_benchmark -- --save-baseline main
          
          # å¯¹æ¯”ç»“æžœ
          cargo criterion --baseline main
      
      - name: ä¸Šä¼ æ€§èƒ½æŠ¥å‘Š
        uses: actions/upload-artifact@v3
        with:
          name: performance-report
          path: target/criterion/

  # Job 5: ä»£ç è´¨é‡æ£€æŸ¥
  code-quality:
    name: ðŸ“ Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: å®‰è£… Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          components: rustfmt, clippy
          override: true
      
      - name: Rustfmt æ£€æŸ¥
        run: cargo fmt -- --check
      
      - name: Clippy æ£€æŸ¥
        run: cargo clippy --workspace -- -D warnings

  # Job 6: æ–‡æ¡£æ£€æŸ¥
  documentation-check:
    name: ðŸ“š Documentation Check
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: å®‰è£… Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
      
      - name: æ£€æŸ¥ Rustdoc
        run: |
          cargo doc --workspace --no-deps --document-private-items
      
      - name: æ£€æŸ¥ CHANGELOG æ›´æ–°
        if: github.event_name == 'pull_request'
        run: |
          CHANGED_FILES=$(git diff --name-only origin/main...HEAD)
          
          # å¦‚æžœä¿®æ”¹äº†æºç ä½†æ²¡æ›´æ–° CHANGELOG
          if echo "$CHANGED_FILES" | grep -q "^src/"; then
            if ! echo "$CHANGED_FILES" | grep -q "^CHANGELOG.md"; then
              echo "::warning::âš ï¸  Source code changed but CHANGELOG.md not updated"
              echo "::warning::Consider updating CHANGELOG.md"
            fi
          fi

  # Job 7: æœ€ç»ˆæ€»ç»“æŠ¥å‘Š
  summary-report:
    name: ðŸ“Š Summary Report
    runs-on: ubuntu-latest
    needs: [kernel-modification-check, dependency-purity-check, unit-tests, performance-benchmarks, code-quality, documentation-check]
    if: always()
    
    steps:
      - name: ç”Ÿæˆæ€»ç»“
        run: |
          echo "## ðŸŽ¯ Kernel Purity & Performance Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Kernel Modification | ${{ needs.kernel-modification-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Purity | ${{ needs.dependency-purity-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | ${{ needs.unit-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Performance | ${{ needs.performance-benchmarks.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Code Quality | ${{ needs.code-quality.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Documentation | ${{ needs.documentation-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "ðŸ“– See [KERNEL-DEFINITION.md](docs/KERNEL-DEFINITION.md) for details" >> $GITHUB_STEP_SUMMARY
